<!DOCTYPE html>
<html>
<head>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      color: #333;
    }
    
    .container {
      padding: 20px;
    }
    
    h2 {
      font-size: 16px;
      margin-bottom: 12px;
    }
    
    .component-item {
      padding: 12px;
      border-radius: 6px;
      background-color: #f5f5f5;
      margin-bottom: 8px;
    }
    
    .library-label {
      display: inline-block;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 3px;
      margin-right: 6px;
      background-color: #e0f2fe;
      color: #0284c7;
    }
    
    .component-name {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .component-id {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }
    
    .library-name {
      font-size: 12px;
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      background-color: #e6f7ff;
      color: #0070e0;
      margin-top: 4px;
    }
    
    .no-components {
      color: #888;
      font-style: italic;
    }
    
    .error-message {
      background-color: #fee2e2;
      color: #b91c1c;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
      font-size: 13px;
    }
    
    .info-message {
      background-color: #f0f9ff;
      color: #075985;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
      font-size: 13px;
    }
    
    .action-button {
      background-color: #0070e0;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      font-size: 13px;
      cursor: pointer;
      margin-top: 16px;
      display: block;
      width: 100%;
    }
    
    .action-button:hover {
      background-color: #0057b3;
    }

    .library-select {
      width: 100%;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      margin-bottom: 16px;
      font-size: 14px;
    }

    .collections-container {
      margin-top: 16px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    .collection-item {
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 6px;
      background-color: #f9fafb;
    }

    .collection-name {
      font-weight: 500;
      font-size: 13px;
    }

    .collection-type {
      font-size: 11px;
      color: #6b7280;
      margin-top: 2px;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-top: 20px;
      margin-bottom: 10px;
      color: #374151;
    }

    .loading {
      text-align: center;
      color: #6b7280;
      font-style: italic;
      padding: 12px;
    }

    .hidden {
      display: none;
    }
    
    /* Estilos para as abas */
    .tabs {
      display: flex;
      border-bottom: 1px solid #e5e7eb;
      background-color: #f3f4f6;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .tab {
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.3s ease;
      text-align: center;
      flex: 1;
    }
    
    .tab.active {
      border-bottom-color: #0070e0;
      color: #0070e0;
      background-color: #fff;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Estilos para a aba Update Collections */
    .variable-form {
      margin-top: 16px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 6px;
      color: #374151;
    }
    
    .form-input, .form-select {
      width: 100%;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
      margin-bottom: 8px;
    }
    
    .form-select {
      background-color: white;
    }
    
    .form-help {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }
    
    .variable-preview {
      background-color: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 12px;
      margin-top: 16px;
    }
    
    .preview-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #374151;
    }
    
    .preview-content {
      font-size: 12px;
      color: #4b5563;
      font-family: 'Roboto Mono', monospace;
      white-space: pre-wrap;
    }
    
    /* Estilos para radio buttons */
    .radio-group {
      margin-bottom: 12px;
    }
    
    .radio-label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      cursor: pointer;
    }
    
    .radio-label input {
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <!-- Abas de navegação -->
  <div class="tabs">
    <div class="tab active" data-tab="update-collections">Update Collections</div>
    <div class="tab" data-tab="update-variables">Update Variables</div>
    <div class="tab" data-tab="list-libs">List Libraries</div>
  </div>
  
  <!-- Conteúdo da Aba Update Collections -->
  <div id="update-collections" class="tab-content active container">
    <h2>Substituir Variáveis</h2>
    <div id="error-container-update" style="display: none;" class="error-message"></div>
    <div id="info-container-update" style="display: none;" class="info-message"></div>
    
    <div class="variable-form">
      <div class="form-group">
        <label class="form-label">Biblioteca de referência:</label>
        <select id="library-select-update" class="form-select">
          <option value="">Carregando bibliotecas...</option>
        </select>
        <p class="form-help">Selecione a biblioteca externa com as variáveis que deseja usar como referência</p>
      </div>
      
      <div class="form-group">
        <label class="form-label">Coleção local:</label>
        <select id="local-collection-select" class="form-select">
          <option value="">Carregando coleções locais...</option>
        </select>
        <p class="form-help">Selecione a coleção local cujas variáveis serão substituídas</p>
      </div>
      
      <div class="variable-preview">
        <div class="preview-title">Pré-visualização:</div>
        <div id="preview-content" class="preview-content">
          Ainda não há nada para pré-visualizar.
          Selecione uma biblioteca externa e uma coleção local para ver as correspondências.
        </div>
      </div>
      
      <button id="update-button" class="action-button" disabled>Substituir Variáveis</button>
    </div>
  </div>
  
  <!-- Conteúdo da Aba Update Variables -->
  <div id="update-variables" class="tab-content container">
    <h2>Substituir Variáveis por Nó</h2>
    <div id="error-container-var" style="display: none;" class="error-message"></div>
    <div id="info-container-var" style="display: none;" class="info-message"></div>
    
    <div class="variable-form">
      <div class="form-group">
        <label class="form-label">Biblioteca de referência:</label>
        <select id="library-select-var" class="form-select">
          <option value="">Carregando bibliotecas...</option>
        </select>
        <p class="form-help">Selecione a biblioteca externa com as variáveis que deseja usar como referência</p>
      </div>
      
      <div class="form-group">
        <label class="form-label">Escopo da substituição:</label>
        <div class="radio-group">
          <label class="radio-label">
            <input type="radio" name="scope" value="selection" checked>
            Seleção atual
          </label>
          <label class="radio-label">
            <input type="radio" name="scope" value="page">
            Página atual
          </label>
          <label class="radio-label">
            <input type="radio" name="scope" value="document">
            Todo o documento
          </label>
        </div>
        <p class="form-help">Escolha onde as variáveis serão substituídas</p>
      </div>
      
      <div class="variable-preview">
        <div class="preview-title">Pré-visualização:</div>
        <div id="preview-content-var" class="preview-content">
          Ainda não há nada para pré-visualizar.
          Selecione uma biblioteca para ver as correspondências.
        </div>
      </div>
      
      <div id="loading-preview-var" class="loading" style="display: none;">
        Procurando variáveis com os mesmos nomes...
      </div>
      
      <button id="update-button-var" class="action-button" disabled>Substituir Variáveis</button>
    </div>
  </div>
  
  <!-- Conteúdo da Aba List Libs (funcionalidade original) -->
  <div id="list-libs" class="tab-content container">
    <h2>Biblioteca Sweep</h2>
    <div id="error-container" style="display: none;" class="error-message"></div>
    <div id="info-container" style="display: none;" class="info-message"></div>

    <!-- Novo seletor de bibliotecas -->
    <div class="section-title">Selecione uma biblioteca:</div>
    <select id="library-select" class="library-select">
      <option value="">Carregando bibliotecas...</option>
    </select>

    <!-- Container para exibir as coleções da biblioteca selecionada -->
    <div class="section-title">Coleções da biblioteca:</div>
    <div id="collections-container" class="collections-container">
      <div id="collections-loading" class="loading">Selecione uma biblioteca para ver suas coleções</div>
      <div id="collections-list" class="hidden"></div>
      <div id="collections-empty" class="no-components hidden">Nenhuma coleção encontrada nesta biblioteca</div>
    </div>

    <!-- Container original para exibir todas as bibliotecas -->
    <div class="section-title">Todas as bibliotecas:</div>
    <div id="components-container">
      <p class="no-components">Procurando bibliotecas...</p>
    </div>
    
    <button id="refresh-button" class="action-button">Recarregar</button>
  </div>

  <script>
    // Elementos do DOM para ambas as abas
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');

    // Elementos da aba List Libs
    const componentsContainer = document.getElementById('components-container');
    const errorContainer = document.getElementById('error-container');
    const infoContainer = document.getElementById('info-container');
    const refreshButton = document.getElementById('refresh-button');
    const librarySelect = document.getElementById('library-select');
    const collectionsContainer = document.getElementById('collections-container');
    const collectionsLoading = document.getElementById('collections-loading');
    const collectionsList = document.getElementById('collections-list');
    const collectionsEmpty = document.getElementById('collections-empty');
    
    // Elementos da aba Update Collections
    const librarySelectUpdate = document.getElementById('library-select-update');
    const localCollectionSelect = document.getElementById('local-collection-select');
    const previewContent = document.getElementById('preview-content');
    const updateButton = document.getElementById('update-button');
    const errorContainerUpdate = document.getElementById('error-container-update');
    const infoContainerUpdate = document.getElementById('info-container-update');
    
    // Elementos da aba Update Variables
    const librarySelectVar = document.getElementById('library-select-var');
    const previewContentVar = document.getElementById('preview-content-var');
    const updateButtonVar = document.getElementById('update-button-var');
    const errorContainerVar = document.getElementById('error-container-var');
    const infoContainerVar = document.getElementById('info-container-var');
    const loadingPreviewVar = document.getElementById('loading-preview-var');
    const previewLoadingVar = document.getElementById('loading-preview-var');
    
    // Função para alternar entre abas
    function switchTab(tabId) {
      // Ocultar todos os conteúdos de abas
      document.querySelectorAll('.tab-content').forEach(content => {
        content.style.display = 'none';
      });
      
      // Desmarcar todas as abas
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Exibir o conteúdo da aba selecionada
      document.getElementById(tabId).style.display = 'block';
      
      // Marcar a aba selecionada
      document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
      
      // Notificar o plugin sobre a mudança de aba
      parent.postMessage({
        pluginMessage: { 
          type: 'activeTabChanged', 
          tabId: tabId 
        }
      }, '*');
    }
    
    // Adicionar listeners para as abas
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', (e) => {
        const tabId = tab.getAttribute('data-tab');
        switchTab(tabId);
      });
    });
    
    // Função para mostrar erro na aba List Libs
    function showError(message) {
      errorContainer.textContent = message || "Ocorreu um erro desconhecido";
      errorContainer.style.display = "block";
    }
    
    // Função para esconder erro na aba List Libs
    function hideError() {
      errorContainer.style.display = "none";
    }
    
    // Função para mostrar informação na aba List Libs
    function showInfo(message) {
      infoContainer.textContent = message || "";
      infoContainer.style.display = message ? "block" : "none";
    }
    
    // Função para mostrar erro na aba Update Collections
    function showErrorUpdate(message) {
      errorContainerUpdate.textContent = message || "Ocorreu um erro desconhecido";
      errorContainerUpdate.style.display = "block";
    }
    
    // Função para esconder erro na aba Update Collections
    function hideErrorUpdate() {
      errorContainerUpdate.style.display = "none";
    }
    
    // Função para mostrar informação na aba Update Collections
    function showInfoUpdate(message) {
      infoContainerUpdate.textContent = message || "";
      infoContainerUpdate.style.display = message ? "block" : "none";
    }

    // Função para mostrar o loading das coleções
    function showCollectionsLoading() {
      collectionsLoading.classList.remove('hidden');
      collectionsList.classList.add('hidden');
      collectionsEmpty.classList.add('hidden');
    }

    // Função para mostrar a lista vazia
    function showCollectionsEmpty() {
      collectionsLoading.classList.add('hidden');
      collectionsList.classList.add('hidden');
      collectionsEmpty.classList.remove('hidden');
    }

    // Função para mostrar a lista de coleções
    function showCollectionsList() {
      collectionsLoading.classList.add('hidden');
      collectionsList.classList.remove('hidden');
      collectionsEmpty.classList.add('hidden');
    }

    // Função para limpar a lista de coleções
    function clearCollectionsList() {
      while (collectionsList.firstChild) {
        collectionsList.removeChild(collectionsList.firstChild);
      }
    }
    
    // Função para atualizar a prévia de substituição de variáveis
    function updatePreview() {
      const libraryId = librarySelectUpdate.value;
      const localCollectionId = localCollectionSelect.value;
      
      if (!libraryId || !localCollectionId) {
        previewContent.textContent = "Ainda não há nada para pré-visualizar.\nSelecione uma biblioteca externa e uma coleção local.";
        updateButton.disabled = true;
        return;
      }
      
      // Solicitar uma prévia das substituições
      previewContent.textContent = "Carregando prévia das correspondências...";
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'preVisualizarSubstituicao', 
          libraryId: libraryId,
          localCollectionId: localCollectionId
        } 
      }, '*');
    }
    
    // Evento para o botão de recarregar
    refreshButton.addEventListener('click', () => {
      componentsContainer.innerHTML = '<p class="no-components">Procurando bibliotecas...</p>';
      librarySelect.innerHTML = '<option value="">Carregando bibliotecas...</option>';
      hideError();
      showInfo("");
      showCollectionsLoading();
      parent.postMessage({ pluginMessage: { type: 'recarregar' } }, '*');
    });

    // Evento para o seletor de bibliotecas
    librarySelect.addEventListener('change', () => {
      const selectedLibraryId = librarySelect.value;
      
      if (!selectedLibraryId) {
        showCollectionsLoading();
        return;
      }
      
      // Limpar e mostrar loading
      clearCollectionsList();
      showCollectionsLoading();
      collectionsLoading.textContent = "Carregando coleções...";
      
      // Solicitar coleções da biblioteca selecionada
      parent.postMessage({ 
        pluginMessage: { 
          type: 'carregarColecoes', 
          libraryId: selectedLibraryId
        } 
      }, '*');
    });
    
    // Evento para o seletor de bibliotecas da aba Update Collections
    librarySelectUpdate.addEventListener('change', updatePreview);
    
    // Evento para o seletor de coleções locais
    localCollectionSelect.addEventListener('change', updatePreview);
    
    // Evento para o botão de atualizar
    updateButton.addEventListener('click', () => {
      const libraryId = librarySelectUpdate.value;
      const localCollectionId = localCollectionSelect.value;
      
      if (!libraryId || !localCollectionId) {
        showErrorUpdate("Selecione uma biblioteca externa e uma coleção local");
        return;
      }
      
      // Verificar e enviar os dados para o plugin
      hideErrorUpdate();
      showInfoUpdate("Iniciando substituição de variáveis...");
      updateButton.disabled = true;
      
      // Enviar solicitação para substituir as variáveis
      parent.postMessage({ 
        pluginMessage: { 
          type: 'substituirVariaveis',
          libraryId: libraryId,
          localCollectionId: localCollectionId
        } 
      }, '*');
    });
    
    // Evento para o seletor de bibliotecas da aba Update Variables
    librarySelectVar.addEventListener('change', () => {
      const selectedLibraryId = librarySelectVar.value;
      
      if (!selectedLibraryId) {
        showCollectionsLoading();
        previewContentVar.textContent = "Ainda não há nada para pré-visualizar.\nSelecione uma biblioteca.";
        updateButtonVar.disabled = true;
        return;
      }
      
      // Limpar e mostrar loading
      clearCollectionsList();
      showCollectionsLoading();
      collectionsLoading.textContent = "Carregando coleções...";
      
      // Atualizar a prévia com a nova biblioteca selecionada
      updatePreviewVar();
      
      // Solicitar coleções da biblioteca selecionada
      parent.postMessage({ 
        pluginMessage: { 
          type: 'carregarColecoes', 
          libraryId: selectedLibraryId
        } 
      }, '*');
    });
    
    // Evento para os radio buttons da aba Update Variables
    document.querySelectorAll('input[name="scope"]').forEach(radio => {
      radio.addEventListener('change', updatePreviewVar);
    });
    
    // Evento para o botão de atualizar
    updateButtonVar.addEventListener('click', () => {
      const libraryId = librarySelectVar.value;
      const scope = document.querySelector('input[name="scope"]:checked').value;
      
      if (!libraryId) {
        alert('Selecione uma biblioteca!');
        return;
      }
      
      // Mostrar loading enquanto processa a substituição
      previewLoadingVar.style.display = 'block';
      
      // Enviar mensagem para substituir variáveis
      parent.postMessage({
        pluginMessage: {
          type: 'substituirVariaveisNos',
          libraryId: libraryId,
          scope: scope
        }
      }, '*');
    });
    
    // Função para atualizar a prévia quando a biblioteca é selecionada
    function updatePreviewVar() {
      const libraryId = librarySelectVar.value;
      const scope = document.querySelector('input[name="scope"]:checked').value;
      
      if (!libraryId) {
        previewContentVar.textContent = "Ainda não há nada para pré-visualizar.\nSelecione uma biblioteca.";
        updateButtonVar.disabled = true;
        return;
      }
      
      // Mostrar loading enquanto processa a prévia
      previewContentVar.textContent = "Procurando variáveis e estilos na seleção atual...";
      previewLoadingVar.style.display = 'block';
      
      // Enviar mensagem para pré-visualizar variáveis com a biblioteca selecionada
      parent.postMessage({
        pluginMessage: {
          type: 'preVisualizarSubstituicaoNos',
          libraryId: libraryId,
          scope: scope
        }
      }, '*');
    }
    
    // Função para mostrar erro na aba Update Variables
    function showErrorVar(message) {
      errorContainerVar.textContent = message || "Ocorreu um erro desconhecido";
      errorContainerVar.style.display = "block";
    }
    
    // Função para esconder erro na aba Update Variables
    function hideErrorVar() {
      errorContainerVar.style.display = "none";
    }
    
    // Função para mostrar informação na aba Update Variables
    function showInfoVar(message) {
      infoContainerVar.textContent = message || "";
      infoContainerVar.style.display = message ? "block" : "none";
    }
    
    // Escuta as mensagens enviadas pelo código do plugin
    window.onmessage = async (event) => {
      try {
        const message = event.data.pluginMessage;
        
        if (!message) {
          showError("Mensagem inválida recebida do plugin");
          return;
        }
        
        // Tratamento de erros
        if (message.type === 'error') {
          showError(message.message);
          showErrorUpdate(message.message);
          showErrorVar(message.message);
          return;
        }
        
        // Recebendo as bibliotecas
        if (message.type === 'libraries-data') {
          const libraries = message.libraries || [];
          showInfo(message.message || "");
          
          // Limpar e preencher o select com as bibliotecas (ambas as abas)
          librarySelect.innerHTML = '';
          librarySelectUpdate.innerHTML = '';
          librarySelectVar.innerHTML = '';
          
          // Adicionar opção padrão
          const defaultOption = document.createElement('option');
          defaultOption.value = '';
          defaultOption.textContent = libraries.length > 0 
            ? 'Selecione uma biblioteca...' 
            : 'Nenhuma biblioteca disponível';
          librarySelect.appendChild(defaultOption);
          
          const defaultOptionUpdate = defaultOption.cloneNode(true);
          librarySelectUpdate.appendChild(defaultOptionUpdate);
          
          const defaultOptionVar = defaultOption.cloneNode(true);
          librarySelectVar.appendChild(defaultOptionVar);
          
          // Adicionar opções para cada biblioteca
          libraries.forEach(library => {
            // Para a aba List Libs
            const option = document.createElement('option');
            option.value = library.id;
            option.textContent = library.name;
            librarySelect.appendChild(option);
            
            // Para a aba Update Collections
            const optionUpdate = option.cloneNode(true);
            librarySelectUpdate.appendChild(optionUpdate);
            
            // Para a aba Update Variables
            const optionVar = option.cloneNode(true);
            librarySelectVar.appendChild(optionVar);
          });
          
          // Carregar coleções locais
          parent.postMessage({ 
            pluginMessage: { 
              type: 'carregarColecoesLocais'
            } 
          }, '*');
          
          // Mostrar bibliotecas no container principal
          componentsContainer.innerHTML = '';
          hideError();
          
          if (!libraries || libraries.length === 0) {
            componentsContainer.innerHTML = '<p class="no-components">Não foram encontradas bibliotecas neste arquivo</p>';
            return;
          }
          
          libraries.forEach((library) => {
            if (!library) return; // Pula bibliotecas inválidas
            
            const libraryElement = document.createElement('div');
            libraryElement.className = 'component-item';
            
            // Adicionar etiqueta do tipo de biblioteca
            const labelElement = document.createElement('span');
            labelElement.className = 'library-label';
            labelElement.textContent = library.type || 'Biblioteca';
            libraryElement.appendChild(labelElement);
            
            // Nome da biblioteca
            const nameElement = document.createElement('div');
            nameElement.className = 'component-name';
            nameElement.textContent = library.name || 'Biblioteca sem nome';
            libraryElement.appendChild(nameElement);
            
            // ID da biblioteca
            const idElement = document.createElement('div');
            idElement.className = 'component-id';
            idElement.textContent = `ID: ${library.id || 'Desconhecido'}`;
            libraryElement.appendChild(idElement);
            
            // Tipo da biblioteca
            if (library.library) {
              const typeElement = document.createElement('div');
              typeElement.className = 'library-name';
              typeElement.textContent = library.library;
              libraryElement.appendChild(typeElement);
            }
            
            componentsContainer.appendChild(libraryElement);
          });
        }
        
        // Recebendo as coleções locais
        if (message.type === 'local-collections-data') {
          const collections = message.collections || [];
          
          // Atualizar o select de coleções locais
          localCollectionSelect.innerHTML = '';
          
          // Adicionar opção padrão
          const defaultOption = document.createElement('option');
          defaultOption.value = '';
          defaultOption.textContent = collections.length > 0 
            ? 'Selecione uma coleção local...' 
            : 'Nenhuma coleção local disponível';
          localCollectionSelect.appendChild(defaultOption);
          
          // Adicionar opções para cada coleção
          collections.forEach(collection => {
            const option = document.createElement('option');
            option.value = collection.id;
            option.textContent = collection.name;
            localCollectionSelect.appendChild(option);
          });
          
          // Habilitar ou desabilitar o select de coleções
          localCollectionSelect.disabled = collections.length === 0;
          
          // Atualizar a prévia
          updatePreview();
        }
        
        // Recebendo prévia de substituição
        if (message.type === 'preview-substituicao') {
          updateButton.disabled = !message.hasMatches;
          
          if (message.hasMatches) {
            let previewText = "Variáveis que serão substituídas:\n\n";
            
            if (message.matches && Array.isArray(message.matches)) {
              message.matches.forEach((match, index) => {
                if (index < 10) { // Limitar a exibição para não sobrecarregar
                  previewText += `- Local: "${match.localName}" → "${match.libraryName}" (${match.mode}, ${match.valueType})\n`;
                }
              });
              
              if (message.matches.length > 10) {
                previewText += `\n... e mais ${message.matches.length - 10} correspondências.`;
              }
              
              previewText += `\n\nTotal: ${message.matches.length} variáveis serão substituídas.`;
            } else {
              previewText += "Correspondências encontradas, mas detalhes não disponíveis.";
            }
            
            previewContent.textContent = previewText;
          } else {
            previewContent.textContent = "Não foram encontradas correspondências entre a coleção local e a biblioteca selecionada.";
          }
        }
        
        // Recebendo prévia de substituição para nós
        if (message.type === 'preview-substituicao-nos') {
          updateButtonVar.disabled = !message.hasMatches;
          
          if (message.hasMatches) {
            let previewText = `Escopo: ${message.scope}\n\n`;
            
            // Mostrar informações resumidas
            previewText += `Encontrados ${message.nodesWithVariables} nós com variáveis e ${message.nodesWithStyles || 0} nós com estilos no escopo atual.\n`;
            previewText += `Total de elementos verificados: ${message.nodeCount}\n\n`;
            
            // === VARIÁVEIS ===
            if (message.variables && message.variables.length > 0) {
              previewText += `=== VARIÁVEIS (${message.variables.length}) ===\n\n`;
              
              // Agrupar por tipo
              if (message.colorVars && message.colorVars.length > 0) {
                previewText += `== CORES (${message.colorVars.length}) ==\n`;
                message.colorVars.slice(0, 5).forEach((v, i) => {
                  previewText += `${i+1}. ${v.varName} - ${v.isRemote ? "Remota" : "Local"}${v.collectionName ? ` (${v.collectionName})` : ""}\n   Nó: "${v.nodeName}" → Prop: ${v.property}\n`;
                });
                if (message.colorVars.length > 5) {
                  previewText += `... e mais ${message.colorVars.length - 5} cores\n`;
                }
                previewText += "\n";
              }
              
              if (message.floatVars && message.floatVars.length > 0) {
                previewText += `== NÚMEROS (${message.floatVars.length}) ==\n`;
                message.floatVars.slice(0, 5).forEach((v, i) => {
                  previewText += `${i+1}. ${v.varName} - ${v.isRemote ? "Remota" : "Local"}${v.collectionName ? ` (${v.collectionName})` : ""}\n   Nó: "${v.nodeName}" → Prop: ${v.property}\n`;
                });
                if (message.floatVars.length > 5) {
                  previewText += `... e mais ${message.floatVars.length - 5} números\n`;
                }
                previewText += "\n";
              }
              
              if (message.stringVars && message.stringVars.length > 0) {
                previewText += `== TEXTOS (${message.stringVars.length}) ==\n`;
                message.stringVars.slice(0, 5).forEach((v, i) => {
                  previewText += `${i+1}. ${v.varName} - ${v.isRemote ? "Remota" : "Local"}${v.collectionName ? ` (${v.collectionName})` : ""}\n   Nó: "${v.nodeName}" → Prop: ${v.property}\n`;
                });
                if (message.stringVars.length > 5) {
                  previewText += `... e mais ${message.stringVars.length - 5} textos\n`;
                }
                previewText += "\n";
              }
              
              if (message.booleanVars && message.booleanVars.length > 0) {
                previewText += `== BOOLEANOS (${message.booleanVars.length}) ==\n`;
                message.booleanVars.slice(0, 5).forEach((v, i) => {
                  previewText += `${i+1}. ${v.varName} - ${v.isRemote ? "Remota" : "Local"}${v.collectionName ? ` (${v.collectionName})` : ""}\n   Nó: "${v.nodeName}" → Prop: ${v.property}\n`;
                });
                if (message.booleanVars.length > 5) {
                  previewText += `... e mais ${message.booleanVars.length - 5} booleanos\n`;
                }
                previewText += "\n";
              }
              
              if (message.aliasVars && message.aliasVars.length > 0) {
                previewText += `== REFERÊNCIAS (${message.aliasVars.length}) ==\n`;
                message.aliasVars.slice(0, 5).forEach((v, i) => {
                  previewText += `${i+1}. ${v.varName} - ${v.isRemote ? "Remota" : "Local"}${v.collectionName ? ` (${v.collectionName})` : ""}\n   Nó: "${v.nodeName}" → Prop: ${v.property}\n`;
                });
                if (message.aliasVars.length > 5) {
                  previewText += `... e mais ${message.aliasVars.length - 5} referências\n`;
                }
                previewText += "\n";
              }
            }
            
            // === ESTILOS ===
            if (message.styles && message.styles.length > 0) {
              previewText += `=== ESTILOS (${message.styles.length}) ===\n\n`;
              
              // Agrupar por tipo
              if (message.fillStyles && message.fillStyles.length > 0) {
                previewText += `== PREENCHIMENTOS (${message.fillStyles.length}) ==\n`;
                message.fillStyles.slice(0, 5).forEach((s, i) => {
                  previewText += `${i+1}. ${s.styleName} - ${s.isRemote ? "Remoto" : "Local"} \n   Nó: "${s.nodeName}" → Tipo: ${s.styleType}\n`;
                });
                if (message.fillStyles.length > 5) {
                  previewText += `... e mais ${message.fillStyles.length - 5} estilos de preenchimento\n`;
                }
                previewText += "\n";
              }
              
              if (message.strokeStyles && message.strokeStyles.length > 0) {
                previewText += `== CONTORNOS (${message.strokeStyles.length}) ==\n`;
                message.strokeStyles.slice(0, 5).forEach((s, i) => {
                  previewText += `${i+1}. ${s.styleName} - ${s.isRemote ? "Remoto" : "Local"} \n   Nó: "${s.nodeName}" → Tipo: ${s.styleType}\n`;
                });
                if (message.strokeStyles.length > 5) {
                  previewText += `... e mais ${message.strokeStyles.length - 5} estilos de contorno\n`;
                }
                previewText += "\n";
              }
              
              if (message.effectStyles && message.effectStyles.length > 0) {
                previewText += `== EFEITOS (${message.effectStyles.length}) ==\n`;
                message.effectStyles.slice(0, 5).forEach((s, i) => {
                  previewText += `${i+1}. ${s.styleName} - ${s.isRemote ? "Remoto" : "Local"} \n   Nó: "${s.nodeName}"\n`;
                });
                if (message.effectStyles.length > 5) {
                  previewText += `... e mais ${message.effectStyles.length - 5} estilos de efeito\n`;
                }
                previewText += "\n";
              }
              
              if (message.textStyles && message.textStyles.length > 0) {
                previewText += `== TEXTOS (${message.textStyles.length}) ==\n`;
                message.textStyles.slice(0, 5).forEach((s, i) => {
                  previewText += `${i+1}. ${s.styleName} - ${s.isRemote ? "Remoto" : "Local"} \n   Nó: "${s.nodeName}"\n`;
                });
                if (message.textStyles.length > 5) {
                  previewText += `... e mais ${message.textStyles.length - 5} estilos de texto\n`;
                }
                previewText += "\n";
              }
              
              if (message.gridStyles && message.gridStyles.length > 0) {
                previewText += `== GRIDS (${message.gridStyles.length}) ==\n`;
                message.gridStyles.slice(0, 5).forEach((s, i) => {
                  previewText += `${i+1}. ${s.styleName} - ${s.isRemote ? "Remoto" : "Local"} \n   Nó: "${s.nodeName}"\n`;
                });
                if (message.gridStyles.length > 5) {
                  previewText += `... e mais ${message.gridStyles.length - 5} estilos de grid\n`;
                }
              }
            }
            
            previewContentVar.textContent = previewText;
          } else {
            previewContentVar.textContent = message.error 
              ? `Erro: ${message.error}` 
              : `Não foram encontradas variáveis ou estilos no escopo selecionado (${message.scope}).`;
          }
          
          // Esconder loading
          loadingPreviewVar.style.display = "none";
        }
        
        // Eventos de loading
        if (message.type === 'loading-preview-start') {
          loadingPreviewVar.style.display = "block";
        }
        
        if (message.type === 'loading-preview-end') {
          loadingPreviewVar.style.display = "none";
        }
        
        // Recebendo resultado de substituição de variáveis para collections
        if (message.type === 'substituicao-result') {
          updateButton.disabled = false;
          
          if (message.success) {
            showInfoUpdate(message.message || "Variáveis substituídas com sucesso!");
          } else {
            showErrorUpdate(message.message || "Erro ao substituir variáveis");
          }
        }
        
        // Recebendo resultado de substituição de variáveis nos nós
        if (message.type === 'substituicao-nos-result') {
          updateButtonVar.disabled = false;
          
          if (message.success) {
            showInfoVar(message.message || "Variáveis substituídas com sucesso!");
          } else {
            showErrorVar(message.message || "Erro ao substituir variáveis");
          }
        }
      } catch (error) {
        console.error("Erro ao processar mensagem:", error);
        showError("Erro ao processar dados: " + (error.message || "erro desconhecido"));
      }
    };
    
    // Informa ao plugin que a UI está pronta
    parent.postMessage({ pluginMessage: { type: 'ui-ready' } }, '*');
  </script>
</body>
</html> 
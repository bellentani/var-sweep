<!DOCTYPE html>
<html>
<head>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 20px;
      color: #333;
    }
    
    h2 {
      font-size: 16px;
      margin-bottom: 12px;
    }
    
    .library-selector {
      width: 100%;
      padding: 8px;
      margin-bottom: 16px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    
    .collections-container {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 16px;
    }
    
    .collection-item {
      padding: 12px;
      border-radius: 6px;
      background-color: #f5f5f5;
      margin-bottom: 8px;
    }
    
    .library-label {
      display: inline-block;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 3px;
      margin-right: 6px;
      background-color: #e0f2fe;
      color: #0284c7;
    }
    
    .collection-name {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .collection-id {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }
    
    .library-name {
      font-size: 12px;
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      background-color: #e6f7ff;
      color: #0070e0;
      margin-top: 4px;
    }
    
    .no-collections {
      color: #888;
      font-style: italic;
      padding: 12px;
    }
    
    .error-message {
      background-color: #fee2e2;
      color: #b91c1c;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
      font-size: 13px;
    }
    
    .info-message {
      background-color: #f0f9ff;
      color: #075985;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
      font-size: 13px;
    }
    
    .action-button {
      background-color: #0070e0;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      font-size: 13px;
      cursor: pointer;
      margin-top: 16px;
      display: block;
      width: 100%;
    }
    
    .action-button:hover {
      background-color: #0057b3;
    }
  </style>
</head>
<body>
  <h2>Bibliotecas de Variáveis</h2>
  <div id="error-container" style="display: none;" class="error-message"></div>
  <div id="info-container" style="display: none;" class="info-message"></div>
  
  <!-- Seletor de bibliotecas -->
  <select id="library-selector" class="library-selector">
    <option value="">Selecione uma biblioteca</option>
  </select>
  
  <!-- Container para as coleções -->
  <div id="collections-container" class="collections-container">
    <p class="no-collections">Selecione uma biblioteca para ver suas coleções</p>
  </div>
  
  <button id="refresh-button" class="action-button">Recarregar</button>

  <script>
    // Elementos do DOM
    const librarySelector = document.getElementById('library-selector');
    const collectionsContainer = document.getElementById('collections-container');
    const errorContainer = document.getElementById('error-container');
    const infoContainer = document.getElementById('info-container');
    const refreshButton = document.getElementById('refresh-button');
    
    // Armazena os dados das bibliotecas
    let libraries = [];
    let collections = {};
    
    // Função para mostrar erro
    function showError(message) {
      errorContainer.textContent = message || "Ocorreu um erro desconhecido";
      errorContainer.style.display = "block";
    }
    
    // Função para esconder erro
    function hideError() {
      errorContainer.style.display = "none";
    }
    
    // Função para mostrar informação
    function showInfo(message) {
      infoContainer.textContent = message || "";
      infoContainer.style.display = message ? "block" : "none";
    }
    
    // Evento para o botão de recarregar
    refreshButton.addEventListener('click', () => {
      collectionsContainer.innerHTML = '<p class="no-collections">Procurando bibliotecas...</p>';
      librarySelector.innerHTML = '<option value="">Selecione uma biblioteca</option>';
      hideError();
      showInfo("");
      parent.postMessage({ pluginMessage: { type: 'recarregar' } }, '*');
    });
    
    // Função para mostrar as coleções da biblioteca selecionada
    librarySelector.addEventListener('change', function() {
      const selectedLibrary = this.value;
      displayCollections(selectedLibrary);
    });
    
    // Função para exibir as coleções de uma biblioteca
    function displayCollections(libraryId) {
      collectionsContainer.innerHTML = '';
      
      if (!libraryId) {
        collectionsContainer.innerHTML = '<p class="no-collections">Selecione uma biblioteca para ver suas coleções</p>';
        return;
      }
      
      // Solicita as coleções desta biblioteca
      parent.postMessage({ 
        pluginMessage: { 
          type: 'obterColecoes', 
          libraryId: libraryId 
        } 
      }, '*');
      
      collectionsContainer.innerHTML = '<p class="no-collections">Carregando coleções...</p>';
    }
    
    // Escuta as mensagens enviadas pelo código do plugin
    window.onmessage = async (event) => {
      try {
        const message = event.data.pluginMessage;
        
        if (!message) {
          showError("Mensagem inválida recebida do plugin");
          return;
        }
        
        // Tratamento de erros
        if (message.type === 'error') {
          showError(message.message);
          return;
        }
        
        // Recebimento da lista de bibliotecas
        if (message.type === 'libraries-data') {
          libraries = message.libraries || [];
          showInfo(message.message || "");
          
          // Limpa o seletor e adiciona a opção padrão
          librarySelector.innerHTML = '<option value="">Selecione uma biblioteca</option>';
          hideError();
          
          if (!libraries || libraries.length === 0) {
            collectionsContainer.innerHTML = '<p class="no-collections">Não foram encontradas bibliotecas neste arquivo</p>';
            return;
          }
          
          // Adiciona as bibliotecas no seletor
          libraries.forEach((library) => {
            if (!library) return; // Pula bibliotecas inválidas
            
            // Só adiciona bibliotecas de variáveis
            if (library.type === 'Variáveis') {
              const option = document.createElement('option');
              option.value = library.id;
              option.textContent = library.name;
              librarySelector.appendChild(option);
            }
          });
          
          if (librarySelector.options.length <= 1) {
            collectionsContainer.innerHTML = '<p class="no-collections">Não foram encontradas bibliotecas de variáveis neste arquivo</p>';
          }
        }
        
        // Recebimento das coleções de uma biblioteca
        if (message.type === 'collections-data') {
          const collectionsData = message.collections || [];
          
          collectionsContainer.innerHTML = '';
          
          if (!collectionsData || collectionsData.length === 0) {
            collectionsContainer.innerHTML = '<p class="no-collections">Esta biblioteca não possui coleções de variáveis</p>';
            return;
          }
          
          // Exibe as coleções
          collectionsData.forEach((collection) => {
            const collectionElement = document.createElement('div');
            collectionElement.className = 'collection-item';
            
            // Nome da coleção
            const nameElement = document.createElement('div');
            nameElement.className = 'collection-name';
            nameElement.textContent = collection.name || 'Coleção sem nome';
            collectionElement.appendChild(nameElement);
            
            // Informações adicionais (se disponíveis)
            if (collection.variableIds && collection.variableIds.length) {
              const infoElement = document.createElement('div');
              infoElement.className = 'collection-id';
              infoElement.textContent = `${collection.variableIds.length} variáveis`;
              collectionElement.appendChild(infoElement);
            }
            
            collectionsContainer.appendChild(collectionElement);
          });
        }
      } catch (error) {
        console.error("Erro ao processar mensagem:", error);
        showError("Erro ao processar dados: " + (error.message || "erro desconhecido"));
      }
    };
    
    // Informa ao plugin que a UI está pronta
    parent.postMessage({ pluginMessage: { type: 'ui-ready' } }, '*');
  </script>
</body>
</html> 
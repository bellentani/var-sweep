<!DOCTYPE html>
<html>
<head>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      color: #333;
    }
    
    .container {
      padding: 20px;
    }
    
    h2 {
      font-size: 16px;
      margin-bottom: 12px;
    }
    
    .component-item {
      padding: 12px;
      border-radius: 6px;
      background-color: #f5f5f5;
      margin-bottom: 8px;
    }
    
    .library-label {
      display: inline-block;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 3px;
      margin-right: 6px;
      background-color: #e0f2fe;
      color: #0284c7;
    }
    
    .component-name {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .component-id {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }
    
    .library-name {
      font-size: 12px;
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      background-color: #e6f7ff;
      color: #0070e0;
      margin-top: 4px;
    }
    
    .no-components {
      color: #888;
      font-style: italic;
    }
    
    .error-message {
      background-color: #fee2e2;
      color: #b91c1c;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
      font-size: 13px;
    }
    
    .info-message {
      background-color: #f0f9ff;
      color: #075985;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
      font-size: 13px;
    }
    
    .action-button {
      background-color: #0070e0;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      font-size: 13px;
      cursor: pointer;
      margin-top: 16px;
      display: block;
      width: 100%;
    }
    
    .action-button:hover {
      background-color: #0057b3;
    }

    .library-select {
      width: 100%;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      margin-bottom: 16px;
      font-size: 14px;
    }

    .collections-container {
      margin-top: 16px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    .collection-item {
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 6px;
      background-color: #f9fafb;
    }

    .collection-name {
      font-weight: 500;
      font-size: 13px;
    }

    .collection-type {
      font-size: 11px;
      color: #6b7280;
      margin-top: 2px;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-top: 20px;
      margin-bottom: 10px;
      color: #374151;
    }

    .loading {
      text-align: center;
      color: #6b7280;
      font-style: italic;
      padding: 12px;
    }

    .hidden {
      display: none;
    }
    
    /* Estilos para as abas */
    .tabs {
      display: flex;
      border-bottom: 1px solid #e5e7eb;
      background-color: #f3f4f6;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .tab {
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.3s ease;
      text-align: center;
      flex: 1;
    }
    
    .tab.active {
      border-bottom-color: #0070e0;
      color: #0070e0;
      background-color: #fff;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Estilos para a aba Update Variables */
    .variable-form {
      margin-top: 16px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 6px;
      color: #374151;
    }
    
    .form-input, .form-select {
      width: 100%;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
      margin-bottom: 8px;
    }
    
    .form-select {
      background-color: white;
    }
    
    .form-help {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }
    
    .variable-preview {
      background-color: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 12px;
      margin-top: 16px;
    }
    
    .preview-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #374151;
    }
    
    .preview-content {
      font-size: 12px;
      color: #4b5563;
      font-family: 'Roboto Mono', monospace;
      white-space: pre-wrap;
    }

    .radio-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }
    
    .radio-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    
    input[type="radio"] {
      margin: 0;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Tab Navigation -->
  <div class="tabs">
    <div class="tab active" data-tab="update-collections">Update Collections</div>
    <div class="tab" data-tab="update-variables">Update Variables</div>
    <div class="tab" data-tab="list-libs">List Libraries</div>
  </div>

  <!-- Tab Contents -->
  <div class="tab-content">
    <!-- Conteúdo da Aba Update Collections -->
    <div class="tab-pane active" id="update-collections">
      <h2>Update Collections</h2>
      <p>Substitua variáveis locais por equivalentes de uma biblioteca.</p>
      <div class="form-group">
        <label for="lib-select">Selecione uma biblioteca:</label>
        <select id="lib-select" class="select-field">
          <option value="">Selecione...</option>
        </select>
      </div>
      <div class="form-group">
        <label for="collection-select">Selecione uma coleção:</label>
        <select id="collection-select" class="select-field">
          <option value="">Selecione...</option>
        </select>
      </div>
      <div class="form-group">
        <button id="update-collection-btn" class="primary-button">Substituir Variáveis</button>
      </div>
      <div id="update-status"></div>
    </div>
    
    <!-- Conteúdo da Aba Update Variables -->
    <div class="tab-pane" id="update-variables">
      <h2>Update Variables</h2>
      <p>Atualize as variáveis aplicadas aos nós/elementos.</p>
      <div class="form-group">
        <p>Funcionalidade em desenvolvimento.</p>
        <p>Esta aba permitirá atualizar variáveis em nós (elementos) ao invés de coleções.</p>
      </div>
    </div>

    <!-- Conteúdo da Aba List Libs -->
    <div class="tab-pane" id="list-libs">
      <h2>Biblioteca Sweep</h2>
      <div id="error-container" style="display: none;" class="error-message"></div>
      <div id="info-container" style="display: none;" class="info-message"></div>
      
      <ul id="library-list" class="library-list">
        <li class="loading">Carregando bibliotecas...</li>
      </ul>
      
      <button id="refresh-button" class="action-button">Recarregar</button>
    </div>
  </div>

  <script>
    // Elementos do DOM para ambas as abas
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');

    // Elementos da aba List Libs
    const componentsContainer = document.getElementById('components-container');
    const errorContainer = document.getElementById('error-container');
    const infoContainer = document.getElementById('info-container');
    const refreshButton = document.getElementById('refresh-button');
    const librarySelect = document.getElementById('library-select');
    const collectionsContainer = document.getElementById('collections-container');
    const collectionsLoading = document.getElementById('collections-loading');
    const collectionsList = document.getElementById('collections-list');
    const collectionsEmpty = document.getElementById('collections-empty');
    
    // Elementos da aba Update Variables
    const librarySelectUpdate = document.getElementById('var-lib-select');
    const localCollectionSelect = document.getElementById('var-collection-select');
    const previewContent = document.getElementById('preview-content');
    const updateButton = document.getElementById('update-variables-btn');
    const errorContainerUpdate = document.getElementById('error-container-update');
    const infoContainerUpdate = document.getElementById('info-container-update');
    
    // Função para alternar entre abas
    function switchTab(tabId) {
      // Remover classe ativa de todas as abas
      tabs.forEach(tab => tab.classList.remove('active'));
      tabContents.forEach(content => content.classList.remove('active'));
      
      // Adicionar classe ativa à aba selecionada
      document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
      document.getElementById(tabId).classList.add('active');
    }
    
    // Adicionar evento de clique às abas
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabId = tab.getAttribute('data-tab');
        switchTab(tabId);
      });
    });
    
    // Função para mostrar erro na aba List Libs
    function showError(message) {
      errorContainer.textContent = message || "Ocorreu um erro desconhecido";
      errorContainer.style.display = "block";
    }
    
    // Função para esconder erro na aba List Libs
    function hideError() {
      errorContainer.style.display = "none";
    }
    
    // Função para mostrar informação na aba List Libs
    function showInfo(message) {
      infoContainer.textContent = message || "";
      infoContainer.style.display = message ? "block" : "none";
    }
    
    // Função para mostrar erro na aba Update Variables
    function showErrorUpdate(message) {
      errorContainerUpdate.textContent = message || "Ocorreu um erro desconhecido";
      errorContainerUpdate.style.display = "block";
    }
    
    // Função para esconder erro na aba Update Variables
    function hideErrorUpdate() {
      errorContainerUpdate.style.display = "none";
    }
    
    // Função para mostrar informação na aba Update Variables
    function showInfoUpdate(message) {
      infoContainerUpdate.textContent = message || "";
      infoContainerUpdate.style.display = message ? "block" : "none";
    }

    // Função para mostrar o loading das coleções
    function showCollectionsLoading() {
      collectionsLoading.classList.remove('hidden');
      collectionsList.classList.add('hidden');
      collectionsEmpty.classList.add('hidden');
    }

    // Função para mostrar a lista vazia
    function showCollectionsEmpty() {
      collectionsLoading.classList.add('hidden');
      collectionsList.classList.add('hidden');
      collectionsEmpty.classList.remove('hidden');
    }

    // Função para mostrar a lista de coleções
    function showCollectionsList() {
      collectionsLoading.classList.add('hidden');
      collectionsList.classList.remove('hidden');
      collectionsEmpty.classList.add('hidden');
    }

    // Função para limpar a lista de coleções
    function clearCollectionsList() {
      while (collectionsList.firstChild) {
        collectionsList.removeChild(collectionsList.firstChild);
      }
    }
    
    // Função para atualizar a prévia de substituição de variáveis
    function updatePreview() {
      const libraryId = librarySelectUpdate.value;
      const localCollectionId = localCollectionSelect.value;
      
      if (!libraryId || !localCollectionId) {
        previewContent.textContent = "Ainda não há nada para pré-visualizar.\nSelecione uma biblioteca externa e uma coleção local.";
        updateButton.disabled = true;
        return;
      }
      
      // Solicitar uma prévia das substituições
      previewContent.textContent = "Carregando prévia das correspondências...";
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'preVisualizarSubstituicao', 
          libraryId: libraryId,
          localCollectionId: localCollectionId
        } 
      }, '*');
    }
    
    // Evento para o botão de recarregar
    refreshButton.addEventListener('click', () => {
      componentsContainer.innerHTML = '<p class="no-components">Procurando bibliotecas...</p>';
      librarySelect.innerHTML = '<option value="">Carregando bibliotecas...</option>';
      hideError();
      showInfo("");
      showCollectionsLoading();
      parent.postMessage({ pluginMessage: { type: 'recarregar' } }, '*');
    });

    // Evento para o seletor de bibliotecas
    librarySelect.addEventListener('change', () => {
      const selectedLibraryId = librarySelect.value;
      
      if (!selectedLibraryId) {
        showCollectionsLoading();
        return;
      }
      
      // Limpar e mostrar loading
      clearCollectionsList();
      showCollectionsLoading();
      collectionsLoading.textContent = "Carregando coleções...";
      
      // Solicitar coleções da biblioteca selecionada
      parent.postMessage({ 
        pluginMessage: { 
          type: 'carregarColecoes', 
          libraryId: selectedLibraryId
        } 
      }, '*');
    });
    
    // Evento para o seletor de bibliotecas da aba Update Variables
    librarySelectUpdate.addEventListener('change', updatePreview);
    
    // Evento para o seletor de coleções locais
    localCollectionSelect.addEventListener('change', updatePreview);
    
    // Evento para o botão de atualizar
    updateButton.addEventListener('click', () => {
      const libraryId = librarySelectUpdate.value;
      const localCollectionId = localCollectionSelect.value;
      
      if (!libraryId || !localCollectionId) {
        showErrorUpdate("Selecione uma biblioteca externa e uma coleção local");
        return;
      }
      
      // Verificar e enviar os dados para o plugin
      hideErrorUpdate();
      showInfoUpdate("Iniciando substituição de variáveis...");
      updateButton.disabled = true;
      
      // Enviar solicitação para substituir as variáveis
      parent.postMessage({ 
        pluginMessage: { 
          type: 'substituirVariaveis',
          libraryId: libraryId,
          localCollectionId: localCollectionId
        } 
      }, '*');
    });
    
    // Escuta as mensagens enviadas pelo código do plugin
    window.onmessage = async (event) => {
      try {
        const message = event.data.pluginMessage;
        
        if (!message) {
          showError("Mensagem inválida recebida do plugin");
          return;
        }
        
        // Tratamento de erros
        if (message.type === 'error') {
          showError(message.message);
          showErrorUpdate(message.message);
          return;
        }
        
        // Recebendo as bibliotecas
        if (message.type === 'libraries-data') {
          const libraries = message.libraries || [];
          showInfo(message.message || "");
          
          // Limpar e preencher o select com as bibliotecas (ambas as abas)
          librarySelect.innerHTML = '';
          librarySelectUpdate.innerHTML = '';
          
          // Adicionar opção padrão
          const defaultOption = document.createElement('option');
          defaultOption.value = '';
          defaultOption.textContent = libraries.length > 0 
            ? 'Selecione uma biblioteca...' 
            : 'Nenhuma biblioteca disponível';
          librarySelect.appendChild(defaultOption);
          
          const defaultOptionUpdate = defaultOption.cloneNode(true);
          librarySelectUpdate.appendChild(defaultOptionUpdate);
          
          // Adicionar opções para cada biblioteca
          libraries.forEach(library => {
            // Para a aba List Libs
            const option = document.createElement('option');
            option.value = library.id;
            option.textContent = library.name;
            librarySelect.appendChild(option);
            
            // Para a aba Update Variables
            const optionUpdate = option.cloneNode(true);
            librarySelectUpdate.appendChild(optionUpdate);
          });
          
          // Carregar coleções locais
          parent.postMessage({ 
            pluginMessage: { 
              type: 'carregarColecoesLocais'
            } 
          }, '*');
          
          // Mostrar bibliotecas no container principal
          componentsContainer.innerHTML = '';
          hideError();
          
          if (!libraries || libraries.length === 0) {
            componentsContainer.innerHTML = '<p class="no-components">Não foram encontradas bibliotecas neste arquivo</p>';
            return;
          }
          
          libraries.forEach((library) => {
            if (!library) return; // Pula bibliotecas inválidas
            
            const libraryElement = document.createElement('div');
            libraryElement.className = 'component-item';
            
            // Adicionar etiqueta do tipo de biblioteca
            const labelElement = document.createElement('span');
            labelElement.className = 'library-label';
            labelElement.textContent = library.type || 'Biblioteca';
            libraryElement.appendChild(labelElement);
            
            // Nome da biblioteca
            const nameElement = document.createElement('div');
            nameElement.className = 'component-name';
            nameElement.textContent = library.name || 'Biblioteca sem nome';
            libraryElement.appendChild(nameElement);
            
            // ID da biblioteca
            const idElement = document.createElement('div');
            idElement.className = 'component-id';
            idElement.textContent = `ID: ${library.id || 'Desconhecido'}`;
            libraryElement.appendChild(idElement);
            
            // Tipo da biblioteca
            if (library.library) {
              const typeElement = document.createElement('div');
              typeElement.className = 'library-name';
              typeElement.textContent = library.library;
              libraryElement.appendChild(typeElement);
            }
            
            componentsContainer.appendChild(libraryElement);
          });
        }
        
        // Recebendo as coleções locais
        if (message.type === 'local-collections-data') {
          const collections = message.collections || [];
          
          // Atualizar o select de coleções locais
          localCollectionSelect.innerHTML = '';
          
          // Adicionar opção padrão
          const defaultOption = document.createElement('option');
          defaultOption.value = '';
          defaultOption.textContent = collections.length > 0 
            ? 'Selecione uma coleção local...' 
            : 'Nenhuma coleção local disponível';
          localCollectionSelect.appendChild(defaultOption);
          
          // Adicionar opções para cada coleção
          collections.forEach(collection => {
            const option = document.createElement('option');
            option.value = collection.id;
            option.textContent = collection.name;
            localCollectionSelect.appendChild(option);
          });
          
          // Habilitar ou desabilitar o select de coleções
          localCollectionSelect.disabled = collections.length === 0;
          
          // Atualizar a prévia
          updatePreview();
        }
        
        // Recebendo prévia de substituição
        if (message.type === 'preview-substituicao') {
          updateButton.disabled = !message.hasMatches;
          
          if (message.hasMatches) {
            let previewText = "Variáveis que serão substituídas:\n\n";
            
            if (message.matches && Array.isArray(message.matches)) {
              message.matches.forEach((match, index) => {
                if (index < 10) { // Limitar a exibição para não sobrecarregar
                  previewText += `- Local: "${match.localName}" → "${match.libraryName}" (${match.mode}, ${match.valueType})\n`;
                }
              });
              
              if (message.matches.length > 10) {
                previewText += `\n... e mais ${message.matches.length - 10} correspondências.`;
              }
              
              previewText += `\n\nTotal: ${message.matches.length} variáveis serão substituídas.`;
            } else {
              previewText += "Correspondências encontradas, mas detalhes não disponíveis.";
            }
            
            previewContent.textContent = previewText;
          } else {
            previewContent.textContent = "Não foram encontradas correspondências entre a coleção local e a biblioteca selecionada.";
          }
        }
        
        // Recebendo resultado de substituição de variáveis
        if (message.type === 'substituicao-result') {
          updateButton.disabled = false;
          
          if (message.success) {
            showInfoUpdate(message.message || "Variáveis substituídas com sucesso!");
          } else {
            showErrorUpdate(message.message || "Erro ao substituir variáveis");
          }
        }
      } catch (error) {
        console.error("Erro ao processar mensagem:", error);
        showError("Erro ao processar dados: " + (error.message || "erro desconhecido"));
      }
    };
    
    // Informa ao plugin que a UI está pronta
    parent.postMessage({ pluginMessage: { type: 'ui-ready' } }, '*');
  </script>
</body>
</html> 
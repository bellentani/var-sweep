<!DOCTYPE html>
<html>
<head>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      padding: 16px;
      color: #333;
    }
    
    .container {
      padding: 20px;
    }
    
    h2 {
      font-size: 16px;
      margin-bottom: 12px;
    }
    
    .component-item {
      padding: 12px;
      border-radius: 6px;
      background-color: #f5f5f5;
      margin-bottom: 8px;
    }
    
    .library-label {
      display: inline-block;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 3px;
      margin-right: 6px;
      background-color: #e0f2fe;
      color: #0284c7;
    }
    
    .component-name {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .component-id {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }
    
    .library-name {
      font-size: 12px;
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      background-color: #e6f7ff;
      color: #0070e0;
      margin-top: 4px;
    }
    
    .no-components {
      color: #888;
      font-style: italic;
    }
    
    .error-message {
      background-color: #ffebee;
      color: #c62828;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
      font-size: 13px;
    }
    
    .info-message {
      background-color: #e3f2fd;
      color: #1565c0;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
      font-size: 13px;
    }
    
    .action-button {
      background-color: #18a0fb;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 13px;
      cursor: pointer;
      margin-top: 16px;
      display: block;
      width: 100%;
    }
    
    .action-button:hover {
      background-color: #0d8fe0;
    }

    .library-select {
      width: 100%;
      padding: 8px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 12px;
    }

    .collections-container {
      margin-top: 16px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    .collection-item {
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 6px;
      background-color: #f9fafb;
    }

    .collection-name {
      font-weight: 500;
      font-size: 13px;
    }

    .collection-type {
      font-size: 11px;
      color: #6b7280;
      margin-top: 2px;
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin: 16px 0 8px;
      padding-bottom: 4px;
      border-bottom: 1px solid #e0e0e0;
      color: #1e1e1e;
    }

    .loading {
      display: none;
      margin: 16px 0;
      color: #666;
      font-style: italic;
    }

    .hidden {
      display: none;
    }
    
    /* Estilos para as abas */
    .tabs {
      display: flex;
      margin-bottom: 16px;
      border-bottom: 1px solid #ddd;
    }
    
    .tab {
      padding: 8px 16px;
      border: none;
      background: none;
      color: #666;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
    }
    
    .tab.active {
      color: #18a0fb;
      border-bottom: 2px solid #18a0fb;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Estilos para a aba Update Collections */
    .variable-form {
      margin-top: 16px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 6px;
      color: #374151;
    }
    
    .form-input, .form-select {
      width: 100%;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
      margin-bottom: 8px;
    }
    
    .form-select {
      background-color: white;
    }
    
    .form-help {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }
    
    .variable-preview {
      background-color: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 12px;
      margin-top: 16px;
    }
    
    .preview-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #374151;
    }
    
    .preview-content {
      font-size: 12px;
      color: #4b5563;
      font-family: 'Roboto Mono', monospace;
      white-space: pre-wrap;
    }
    
    /* Estilos para radio buttons */
    .radio-group {
      margin-bottom: 12px;
    }
    
    .radio-label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      cursor: pointer;
    }
    
    .radio-label input {
      margin-right: 8px;
    }

    .secondary-button {
      background-color: #f3f4f6;
      color: #374151;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      padding: 8px 16px;
      font-size: 13px;
      cursor: pointer;
      margin-top: 8px;
      display: block;
      width: 100%;
    }
    
    .secondary-button:hover {
      background-color: #e5e7eb;
    }

    .secondary-button:disabled {
      background-color: #f3f4f6;
      color: #9ca3af;
      cursor: not-allowed;
    }

    .action-button:disabled {
      background-color: #9ca3af;
      cursor: not-allowed;
    }

    .preview-section {
      margin-bottom: 16px;
    }

    .preview-subtitle {
      font-size: 12px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }

    .preview-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .preview-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 8px;
      border-radius: 4px;
      background-color: #ffffff;
      margin-bottom: 4px;
      font-size: 12px;
    }

    .preview-item:hover {
      background-color: #f3f4f6;
    }

    .variable-name {
      color: #111827;
      font-family: 'Roboto Mono', monospace;
    }

    .variable-collection {
      color: #6b7280;
      font-size: 11px;
      padding: 2px 6px;
      background-color: #f3f4f6;
      border-radius: 3px;
    }

    .preview-more {
      font-size: 11px;
      color: #6b7280;
      padding: 4px 8px;
      font-style: italic;
    }

    /* Grupos de variáveis/estilos - Layout mais compacto */
    .variable-group {
      margin-bottom: 12px;
    }

    .variable-group h3 {
      font-size: 11px;
      font-weight: 500;
      margin: 4px 0;
      color: #666;
    }

    .variable-group ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .variable-group li {
      display: flex;
      align-items: center;
      padding: 3px 6px;
      margin: 1px 0;
      border-radius: 3px;
      background: #f5f5f5;
      font-size: 11px;
    }

    .variable-group li:hover {
      background: #eee;
    }

    .var-name {
      flex: 1;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 150px;
    }

    .var-type {
      padding: 1px 4px;
      margin: 0 4px;
      border-radius: 3px;
      font-size: 10px;
    }

    .var-collection {
      font-size: 10px;
      color: #999;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 80px;
    }

    .more-items {
      color: #666;
      font-style: italic;
      text-align: center;
      padding: 2px 0;
    }

    .load-more-button {
      background-color: transparent;
      color: #18a0fb;
      border: 1px solid #18a0fb;
      border-radius: 3px;
      padding: 2px 8px;
      font-size: 10px;
      cursor: pointer;
      margin: 4px auto;
      display: block;
      width: auto;
    }

    .load-more-button:hover {
      background-color: #e8f4fd;
    }

    /* Seções - Layout mais compacto */
    .section-title {
      font-size: 12px;
      font-weight: 600;
      margin: 12px 0 6px;
      padding-bottom: 3px;
      border-bottom: 1px solid #e0e0e0;
      color: #1e1e1e;
    }

    /* Tipos específicos de variáveis */
    .var-type.color {
      background: #ffebee;
      color: #c62828;
    }

    .var-type.number {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .var-type.text {
      background: #e3f2fd;
      color: #1565c0;
    }

    .var-type.boolean {
      background: #fff3e0;
      color: #ef6c00;
    }

    /* Tipos específicos de estilos */
    .var-type.fill {
      background: #f3e5f5;
      color: #7b1fa2;
    }

    .var-type.stroke {
      background: #e8eaf6;
      color: #3949ab;
    }

    .var-type.effect {
      background: #e0f2f1;
      color: #00695c;
    }

    .var-type.text-style {
      background: #fce4ec;
      color: #c2185b;
    }

    .var-type.grid {
      background: #f1f8e9;
      color: #558b2f;
    }

    /* Mensagens */
    .message {
      padding: 8px 12px;
      margin: 8px 0;
      border-radius: 4px;
      font-size: 12px;
    }

    .error {
      background: #ffebee;
      color: #c62828;
    }

    .info {
      background: #e3f2fd;
      color: #1565c0;
    }

    /* Estilo para a lista de correspondências */
    .variables-list {
      margin-top: 10px;
    }
    
    .match-item {
      padding: 8px;
      background-color: #f9fafb;
      border-radius: 4px;
      margin-bottom: 6px;
      font-size: 12px;
    }
    
    .match-local {
      margin-bottom: 4px;
    }
    
    .match-library {
      color: #666;
      font-size: 11px;
    }
    
    .warning {
      color: #b45309;
      font-style: italic;
    }

    /* Adicionando estilos para a visualização de correspondências */
    .matches-pagination {
      margin-top: 10px;
      display: flex;
      gap: 8px;
    }
    
    .pagination-button {
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
    }
    
    .pagination-button:hover {
      background-color: #e0e0e0;
    }
    
    .match-item {
      padding: 8px;
      border-bottom: 1px solid #eee;
      margin-bottom: 0;
    }
    
    .matches-container {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-top: 8px;
    }
    
    .match-local {
      font-size: 13px;
      margin-bottom: 4px;
    }
    
    .match-library {
      font-size: 12px;
      color: #666;
    }
    
    .matches-count {
      font-size: 14px;
      font-weight: 500;
      color: #333;
      margin-bottom: 8px;
    }
    
    .matches-filter {
      margin-bottom: 10px;
    }
    
    .matches-filter input {
      width: 100%;
      padding: 6px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 12px;
    }

    /* Estilos para os modos e valores das variáveis */
    .modes-container {
      margin-top: 10px;
      background-color: white;
      border-radius: 6px;
      padding: 10px;
    }

    .modes-title {
      font-weight: 600;
      font-size: 12px;
      margin-bottom: 5px;
      color: #333;
    }

    .modes-list {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .mode-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 10px;
      background-color: #f4f4f4;
      border-radius: 4px;
    }

    .mode-name {
      font-weight: 500;
      font-size: 12px;
      padding: 3px 10px;
      background-color: #4b4b4b;
      color: white;
      border-radius: 3px;
    }

    .mode-value {
      font-family: 'Roboto Mono', monospace;
      font-size: 12px;
      padding: 3px 10px;
    }

    .match-header {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .match-item {
      padding: 15px;
      border-bottom: 1px solid #eee;
      margin-bottom: 10px;
      background-color: #f9fafb;
      border-radius: 6px;
    }

    .preview-header {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .matches-count {
      font-size: 14px;
      margin-bottom: 16px;
      color: #666;
    }

    .matches-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .match-item {
      background-color: #f5f5f5;
      border-radius: 8px;
      padding: 16px;
    }

    .variavel {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 12px;
      color: #333;
    }

    .modes-container {
      background-color: #ffffff;
      border-radius: 6px;
      padding: 12px;
      margin-top: 8px;
    }

    .modes-title {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 8px;
      color: #333;
    }

    .modes-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .mode-row {
      display: flex;
      align-items: center;
      background-color: #f9f9f9;
      border-radius: 4px;
      overflow: hidden;
    }

    .mode-name {
      background-color: #666;
      color: white;
      padding: 4px 8px;
      font-size: 12px;
      font-weight: 500;
      min-width: 80px;
    }

    .mode-value {
      padding: 4px 8px;
      font-size: 12px;
      font-family: monospace;
      color: #333;
      flex-grow: 1;
    }

    .matches-pagination {
      margin-top: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
    }

    .pagination-button {
      background-color: #f0f0f0;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
    }

    .pagination-button:hover {
      background-color: #e0e0e0;
    }
  </style>
</head>
<body>
  <!-- Abas de navegação -->
  <div class="tabs">
    <div class="tab active" data-tab="update-collections">Update Collections</div>
    <div class="tab" data-tab="update-variables">Update Variables</div>
    <div class="tab" data-tab="list-libs">List Libraries</div>
  </div>
  
  <!-- Conteúdo da Aba Update Collections -->
  <div id="update-collections" class="tab-content active container">
    <h2>Substituir Variáveis</h2>
    <div id="error-container-update" style="display: none;" class="error-message"></div>
    <div id="info-container-update" style="display: none;" class="info-message"></div>
    
    <div class="variable-form">
      <div class="form-group">
        <label class="form-label">Biblioteca de referência:</label>
        <select id="library-select-update" class="form-select">
          <option value="">Carregando bibliotecas...</option>
        </select>
        <p class="form-help">Selecione a biblioteca externa com as variáveis que deseja usar como referência</p>
      </div>
      
      <div class="form-group">
        <label class="form-label">Coleção local:</label>
        <select id="local-collection-select" class="form-select">
          <option value="">Carregando coleções locais...</option>
        </select>
        <p class="form-help">Selecione a coleção local cujas variáveis serão substituídas</p>
      </div>
      
      <div class="variable-preview">
        <div class="preview-title">Pré-visualização:</div>
        <div id="preview-content" class="preview-content">
          Ainda não há nada para pré-visualizar.
          Selecione uma biblioteca externa e uma coleção local para ver as correspondências.
        </div>
      </div>
      
      <button id="update-button" class="action-button" disabled>Substituir Variáveis</button>
    </div>
  </div>
  
  <!-- Conteúdo da Aba Update Variables -->
  <div id="update-variables" class="tab-content container">
    <h2>Substituir Variáveis por Nó</h2>
    <div id="error-container-var" style="display: none;" class="error-message"></div>
    <div id="info-container-var" style="display: none;" class="info-message"></div>
    
    <div class="variable-form">
      <div class="form-group">
        <label class="form-label">Biblioteca de referência:</label>
        <select id="library-select-var" class="form-select">
          <option value="">Carregando bibliotecas...</option>
        </select>
        <p class="form-help">Selecione a biblioteca externa com as variáveis que deseja usar como referência</p>
      </div>
      
      <div class="form-group">
        <label class="form-label">Escopo de substituição</label>
        <div class="radio-group">
          <input type="radio" id="selection" name="scope" value="selection" checked>
          <label for="selection">Seleção atual</label>
        </div>
        <div class="radio-group">
          <input type="radio" id="page" name="scope" value="page">
          <label for="page">Página atual</label>
        </div>
        <button id="searchVariablesBtn" class="secondary-button">
          Procurar variáveis e estilos
        </button>
      </div>
      
      <div id="variable-preview" class="variable-preview hidden">
        <div class="preview-title">Variáveis e estilos encontrados</div>
        <div id="preview-content-var" class="preview-content">
          <!-- Lista de variáveis será inserida aqui -->
        </div>
      </div>
      
      <div id="loading-preview-var" class="loading" style="display: none;">
        Procurando variáveis com os mesmos nomes...
      </div>
      
      <button id="update-button-var" class="action-button" disabled>Substituir Variáveis</button>
    </div>
  </div>
  
  <!-- Conteúdo da Aba List Libs (funcionalidade original) -->
  <div id="list-libs" class="tab-content container">
    <h2>Biblioteca Sweep</h2>
    <div id="error-container" style="display: none;" class="error-message"></div>
    <div id="info-container" style="display: none;" class="info-message"></div>

    <!-- Novo seletor de bibliotecas -->
    <div class="section-title">Selecione uma biblioteca:</div>
    <select id="library-select" class="library-select">
      <option value="">Carregando bibliotecas...</option>
    </select>

    <!-- Container para exibir as coleções da biblioteca selecionada -->
    <div class="section-title">Coleções da biblioteca:</div>
    <div id="collections-container" class="collections-container">
      <div id="collections-loading" class="loading">Selecione uma biblioteca para ver suas coleções</div>
      <div id="collections-list" class="hidden"></div>
      <div id="collections-empty" class="no-components hidden">Nenhuma coleção encontrada nesta biblioteca</div>
    </div>

    <!-- Container original para exibir todas as bibliotecas -->
    <div class="section-title">Todas as bibliotecas:</div>
    <div id="components-container">
      <p class="no-components">Procurando bibliotecas...</p>
    </div>
    
    <button id="refresh-button" class="action-button">Recarregar</button>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
    // Elementos do DOM para ambas as abas
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');

      // Elementos da interface
    const componentsContainer = document.getElementById('components-container');
    const errorContainer = document.getElementById('error-container');
    const infoContainer = document.getElementById('info-container');
    const refreshButton = document.getElementById('refresh-button');
    const librarySelect = document.getElementById('library-select');
    const collectionsContainer = document.getElementById('collections-container');
    const collectionsLoading = document.getElementById('collections-loading');
    const collectionsList = document.getElementById('collections-list');
    const collectionsEmpty = document.getElementById('collections-empty');
    const librarySelectUpdate = document.getElementById('library-select-update');
    const localCollectionSelect = document.getElementById('local-collection-select');
    const previewContent = document.getElementById('preview-content');
    const updateButton = document.getElementById('update-button');
    const errorContainerUpdate = document.getElementById('error-container-update');
    const infoContainerUpdate = document.getElementById('info-container-update');
      const librarySelectVar = document.getElementById('library-select-var');
      const previewContentVar = document.getElementById('preview-content-var');
      const updateButtonVar = document.getElementById('update-button-var');
      const errorContainerVar = document.getElementById('error-container-var');
      const infoContainerVar = document.getElementById('info-container-var');
      const loadingPreviewVar = document.getElementById('loading-preview-var');
      const searchVariablesBtn = document.getElementById('searchVariablesBtn');
      const variablePreview = document.getElementById('variable-preview');
      
      // Variável para armazenar as variáveis encontradas
      let foundVariables = [];
    
    // Função para alternar entre abas
    function switchTab(tabId) {
        // Ocultar todos os conteúdos de abas
        document.querySelectorAll('.tab-content').forEach(content => {
          content.style.display = 'none';
        });
        
        // Desmarcar todas as abas
        document.querySelectorAll('.tab').forEach(tab => {
          tab.classList.remove('active');
        });
        
        // Exibir o conteúdo da aba selecionada
        document.getElementById(tabId).style.display = 'block';
        
        // Marcar a aba selecionada
      document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
        
        // Notificar o plugin sobre a mudança de aba
        parent.postMessage({
          pluginMessage: { 
            type: 'activeTabChanged', 
            tabId: tabId 
          }
        }, '*');
      }
      
      // Adicionar listeners para as abas
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
        const tabId = tab.getAttribute('data-tab');
        switchTab(tabId);
      });
    });
    
    // Função para mostrar erro na aba List Libs
    function showError(message) {
      errorContainer.textContent = message || "Ocorreu um erro desconhecido";
      errorContainer.style.display = "block";
    }
    
    // Função para esconder erro na aba List Libs
    function hideError() {
      errorContainer.style.display = "none";
    }
    
    // Função para mostrar informação na aba List Libs
    function showInfo(message) {
      infoContainer.textContent = message || "";
      infoContainer.style.display = message ? "block" : "none";
    }
    
      // Função para mostrar erro na aba Update Collections
    function showErrorUpdate(message) {
      errorContainerUpdate.textContent = message || "Ocorreu um erro desconhecido";
      errorContainerUpdate.style.display = "block";
    }
    
      // Função para esconder erro na aba Update Collections
    function hideErrorUpdate() {
      errorContainerUpdate.style.display = "none";
    }
    
      // Função para mostrar informação na aba Update Collections
    function showInfoUpdate(message) {
      infoContainerUpdate.textContent = message || "";
      infoContainerUpdate.style.display = message ? "block" : "none";
    }

    // Função para mostrar o loading das coleções
    function showCollectionsLoading() {
      collectionsLoading.classList.remove('hidden');
      collectionsList.classList.add('hidden');
      collectionsEmpty.classList.add('hidden');
    }

    // Função para mostrar a lista vazia
    function showCollectionsEmpty() {
      collectionsLoading.classList.add('hidden');
      collectionsList.classList.add('hidden');
      collectionsEmpty.classList.remove('hidden');
    }

    // Função para mostrar a lista de coleções
    function showCollectionsList() {
      collectionsLoading.classList.add('hidden');
      collectionsList.classList.remove('hidden');
      collectionsEmpty.classList.add('hidden');
    }

    // Função para limpar a lista de coleções
    function clearCollectionsList() {
      while (collectionsList.firstChild) {
        collectionsList.removeChild(collectionsList.firstChild);
      }
    }
    
    // Função para atualizar a prévia de substituição de variáveis
    function updatePreview() {
      const libraryId = librarySelectUpdate.value;
      const localCollectionId = localCollectionSelect.value;
      
      if (!libraryId || !localCollectionId) {
        previewContent.textContent = "Ainda não há nada para pré-visualizar.\nSelecione uma biblioteca externa e uma coleção local.";
        updateButton.disabled = true;
        return;
      }
      
      // Solicitar uma prévia das substituições
      previewContent.textContent = "Carregando prévia das correspondências...";
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'preVisualizarSubstituicao', 
          libraryId: libraryId,
          localCollectionId: localCollectionId
        } 
      }, '*');
    }
    
    // Evento para o botão de recarregar
    refreshButton.addEventListener('click', () => {
      componentsContainer.innerHTML = '<p class="no-components">Procurando bibliotecas...</p>';
      librarySelect.innerHTML = '<option value="">Carregando bibliotecas...</option>';
      hideError();
      showInfo("");
      showCollectionsLoading();
      parent.postMessage({ pluginMessage: { type: 'recarregar' } }, '*');
    });

    // Evento para o seletor de bibliotecas
    librarySelect.addEventListener('change', () => {
      const selectedLibraryId = librarySelect.value;
      
      if (!selectedLibraryId) {
        showCollectionsLoading();
        return;
      }
      
      // Limpar e mostrar loading
      clearCollectionsList();
      showCollectionsLoading();
      collectionsLoading.textContent = "Carregando coleções...";
      
      // Solicitar coleções da biblioteca selecionada
      parent.postMessage({ 
        pluginMessage: { 
          type: 'carregarColecoes', 
          libraryId: selectedLibraryId
        } 
      }, '*');
    });
    
      // Evento para o seletor de bibliotecas da aba Update Collections
    librarySelectUpdate.addEventListener('change', updatePreview);
    
    // Evento para o seletor de coleções locais
    localCollectionSelect.addEventListener('change', updatePreview);
    
    // Evento para o botão de atualizar
    updateButton.addEventListener('click', () => {
      const libraryId = librarySelectUpdate.value;
      const localCollectionId = localCollectionSelect.value;
      
      if (!libraryId || !localCollectionId) {
        showErrorUpdate("Selecione uma biblioteca externa e uma coleção local");
        return;
      }
      
      // Verificar e enviar os dados para o plugin
      hideErrorUpdate();
      showInfoUpdate("Iniciando substituição de variáveis...");
      updateButton.disabled = true;
      
      // Se tivermos correspondências disponíveis, use-as para substituir
      if (window.matchesData && window.matchesData.length > 0) {
        // Enviar solicitação para substituir as variáveis na coleção
        parent.postMessage({ 
          pluginMessage: { 
            type: 'substituirVariaveisEmColecao',
            matches: window.matchesData
          } 
        }, '*');
      } else {
        showErrorUpdate("Nenhuma correspondência encontrada para substituir");
        updateButton.disabled = false;
      }
    });
    
      // Evento para o seletor de bibliotecas da aba Update Variables
      librarySelectVar.addEventListener('change', () => {
        const selectedLibraryId = librarySelectVar.value;
        
        if (!selectedLibraryId) {
          showCollectionsLoading();
          previewContentVar.textContent = "Ainda não há nada para pré-visualizar.\nSelecione uma biblioteca.";
          updateButtonVar.disabled = true;
          return;
        }
        
        // Limpar e mostrar loading
        clearCollectionsList();
        showCollectionsLoading();
        collectionsLoading.textContent = "Carregando coleções...";
        
        // Atualizar a prévia com a nova biblioteca selecionada
        updatePreviewVar();
        
        // Solicitar coleções da biblioteca selecionada
        parent.postMessage({ 
          pluginMessage: { 
            type: 'carregarColecoes', 
            libraryId: selectedLibraryId
          } 
        }, '*');
      });
      
      // Evento para os radio buttons da aba Update Variables
      document.querySelectorAll('input[name="scope"]').forEach(radio => {
        radio.addEventListener('change', updatePreviewVar);
      });
      
      // Evento para o botão de atualizar
      updateButtonVar.addEventListener('click', () => {
        const libraryId = librarySelectVar.value;
        const scope = document.querySelector('input[name="scope"]:checked').value;
        
        if (!libraryId) {
          alert('Selecione uma biblioteca!');
          return;
        }
        
        // Mostrar loading enquanto processa a substituição
        loadingPreviewVar.style.display = 'block';
        
        // Enviar mensagem para substituir variáveis
      parent.postMessage({ 
        pluginMessage: { 
          type: 'substituirVariaveis',
          libraryId: libraryId,
            scope: scope,
            variables: foundVariables
        } 
      }, '*');
    });
    
      // Função para atualizar a prévia quando a biblioteca é selecionada
      function updatePreviewVar() {
        const libraryId = librarySelectVar.value;
        const scope = document.querySelector('input[name="scope"]:checked').value;
        
        if (!libraryId) {
          previewContentVar.textContent = "Ainda não há nada para pré-visualizar.\nSelecione uma biblioteca.";
          updateButtonVar.disabled = true;
          return;
        }
        
        // Mostrar loading enquanto processa a prévia
        previewContentVar.textContent = "Procurando variáveis e estilos na seleção atual...";
        loadingPreviewVar.style.display = 'block';
        
        // Enviar mensagem para pré-visualizar variáveis com a biblioteca selecionada
        parent.postMessage({
          pluginMessage: {
            type: 'search-variables',
            libraryId: libraryId,
            scope: scope
          }
        }, '*');
      }
      
      // Função para mostrar erro na aba Update Variables
      function showErrorVar(message) {
        errorContainerVar.textContent = message || "Ocorreu um erro desconhecido";
        errorContainerVar.style.display = "block";
      }
      
      // Função para esconder erro na aba Update Variables
      function hideErrorVar() {
        errorContainerVar.style.display = "none";
      }
      
      // Função para mostrar informação na aba Update Variables
      function showInfoVar(message) {
        infoContainerVar.textContent = message || "";
        infoContainerVar.style.display = message ? "block" : "none";
      }
      
      // Função para formatar a lista de variáveis
      function formatVariablesList(variables) {
        if (!variables || variables.length === 0) {
          return '<p>Nenhuma variável ou estilo encontrado.</p>';
        }

        let html = '';

        // Agrupar variáveis e estilos por tipo
        const groups = {
          colors: variables.filter(v => v.type === 'COLOR'),
          numbers: variables.filter(v => v.type === 'FLOAT'),
          texts: variables.filter(v => v.type === 'STRING'),
          booleans: variables.filter(v => v.type === 'BOOLEAN'),
          fills: variables.filter(v => v.property === 'fill'),
          strokes: variables.filter(v => v.property === 'stroke'),
          effects: variables.filter(v => v.property === 'effect'),
          textStyles: variables.filter(v => v.property === 'text'),
          grids: variables.filter(v => v.property === 'grid')
        };

        // Primeiro, mostrar as variáveis
        if (groups.colors.length > 0 || groups.numbers.length > 0 || 
            groups.texts.length > 0 || groups.booleans.length > 0) {
          html += '<div class="section-title">Variáveis</div>';
          
          // Mapeamento de nomes amigáveis para os tipos de variáveis
          const varNames = {
            colors: 'Cores',
            numbers: 'Números',
            texts: 'Textos',
            booleans: 'Booleanos'
          };
          
          // Gerar HTML para cada grupo de variáveis
          ['colors', 'numbers', 'texts', 'booleans'].forEach(groupName => {
            const items = groups[groupName];
            if (items.length > 0) {
              const groupId = `group-${groupName}`;
              html += `<div class="variable-group" data-group="${groupId}">
                <h3>${varNames[groupName]} (${items.length})</h3>
                <ul>`;

              items.slice(0, 5).forEach(item => {
                html += `<li>
                  <span class="var-name" title="${item.name}">${item.name}</span>
                  <span class="var-type ${groupName.slice(0, -1)}">${item.type}</span>
                  ${item.collection ? `<span class="var-collection" title="${item.collection}">${item.collection}</span>` : ''}
                </li>`;
              });

              if (items.length > 5) {
                html += `<li class="more-items">
                  <button class="load-more-button" data-group="${groupId}" data-type="${groupName}">
                    Mostrar +${items.length - 5} itens
                  </button>
                </li>`;
              }

              html += '</ul></div>';
            }
          });
        }

        // Depois, mostrar os estilos
        if (groups.fills.length > 0 || groups.strokes.length > 0 || 
            groups.effects.length > 0 || groups.textStyles.length > 0 || 
            groups.grids.length > 0) {
          html += '<div class="section-title">Estilos</div>';
          
          // Mapeamento de nomes amigáveis para os tipos de estilo
          const styleNames = {
            fills: 'Preenchimentos',
            strokes: 'Contornos',
            effects: 'Efeitos',
            textStyles: 'Textos',
            grids: 'Grids'
          };
          
          // Mapeamento de classes CSS para os tipos de estilo
          const styleClasses = {
            fills: 'fill',
            strokes: 'stroke',
            effects: 'effect',
            textStyles: 'text-style',
            grids: 'grid'
          };
          
          // Gerar HTML para cada grupo de estilos
          ['fills', 'strokes', 'effects', 'textStyles', 'grids'].forEach(groupName => {
            const items = groups[groupName];
            if (items.length > 0) {
              const groupId = `group-${groupName}`;
              html += `<div class="variable-group" data-group="${groupId}">
                <h3>${styleNames[groupName]} (${items.length})</h3>
                <ul>`;

              items.slice(0, 5).forEach(item => {
                html += `<li>
                  <span class="var-name" title="${item.name}">${item.name}</span>
                  <span class="var-type ${styleClasses[groupName]}">Estilo</span>
                  ${item.collection ? `<span class="var-collection" title="${item.collection}">${item.collection}</span>` : ''}
                </li>`;
              });

              if (items.length > 5) {
                html += `<li class="more-items">
                  <button class="load-more-button" data-group="${groupId}" data-type="${groupName}">
                    Mostrar +${items.length - 5} itens
                  </button>
                </li>`;
              }

              html += '</ul></div>';
            }
          });
        }

        return html || '<p>Nenhuma variável ou estilo encontrado.</p>';
      }

      // Variável para armazenar as variáveis completas por grupo
      let variablesByGroup = {};

      // Evento de clique no botão de procurar variáveis
      searchVariablesBtn.addEventListener('click', function() {
        searchVariablesBtn.disabled = true;
        variablePreview.classList.remove('hidden');
        previewContentVar.innerHTML = '<div class="loading">Procurando variáveis e estilos...</div>';
        
        // Envia mensagem para o plugin procurar as variáveis
        parent.postMessage({ pluginMessage: { type: 'search-variables' } }, '*');
      });

      // Manipulador de mensagens do plugin
    window.onmessage = async (event) => {
        const message = event.data.pluginMessage;
        console.log('Mensagem recebida:', message);

        if (!message) return;

        switch (message.type) {
          case 'variables-found':
            searchVariablesBtn.disabled = false;
            updateButtonVar.disabled = false;
            // Armazena as variáveis encontradas para uso posterior
            foundVariables = message.variables;
            
            // Organiza as variáveis por grupo para o carregamento posterior
            variablesByGroup = {
              colors: foundVariables.filter(v => v.type === 'COLOR'),
              numbers: foundVariables.filter(v => v.type === 'FLOAT'),
              texts: foundVariables.filter(v => v.type === 'STRING'),
              booleans: foundVariables.filter(v => v.type === 'BOOLEAN'),
              fills: foundVariables.filter(v => v.property === 'fill'),
              strokes: foundVariables.filter(v => v.property === 'stroke'),
              effects: foundVariables.filter(v => v.property === 'effect'),
              textStyles: foundVariables.filter(v => v.property === 'text'),
              grids: foundVariables.filter(v => v.property === 'grid')
            };
            
            previewContentVar.innerHTML = formatVariablesList(message.variables);
            
            // Adiciona os event listeners para os botões de carregar mais
            document.querySelectorAll('.load-more-button').forEach(button => {
              button.addEventListener('click', handleLoadMoreClick);
            });
            
            // Esconde o loading
            loadingPreviewVar.style.display = 'none';
            break;

          case 'no-variables-found':
            searchVariablesBtn.disabled = false;
            updateButtonVar.disabled = true;
            // Limpa as variáveis encontradas
            foundVariables = [];
            variablesByGroup = {};
            previewContentVar.innerHTML = '<p>Nenhuma variável ou estilo encontrado nos elementos selecionados.</p>';
            // Esconde o loading
            loadingPreviewVar.style.display = 'none';
            break;
            
          case 'preview-correspondencias':
            // Atualizar a pré-visualização das correspondências
            if (message.hasMatches) {
              // Armazenar as correspondências para usar na substituição
              window.matchesData = message.matches;
              
              updateButton.disabled = false;
              
              // Reiniciar estado da paginação
              window.paginationState = {
                currentPage: 1,
                itemsPerPage: 30,
                showingAll: false
              };
              
              // Atualizar a exibição usando a função de paginação
              updateMatchesDisplay();
            } else {
              // Limpar as correspondências armazenadas
              window.matchesData = [];
              
              updateButton.disabled = true;
              previewContent.innerHTML = `<p class="warning">${message.message || 'Não há correspondências'}</p>`;
              if (message.error) {
                previewContent.innerHTML += `<p class="error">${message.error}</p>`;
              }
            }
            break;
            
          case 'local-collections-data':
            // Atualizar o dropdown de coleções locais
            localCollectionSelect.innerHTML = '';
            
            if (!message.collections || message.collections.length === 0) {
              const defaultOption = document.createElement('option');
              defaultOption.value = '';
              defaultOption.textContent = 'Nenhuma coleção local disponível';
              localCollectionSelect.appendChild(defaultOption);
              showErrorUpdate('Nenhuma coleção local encontrada. Crie coleções de variáveis locais primeiro.');
            } else {
              // Adicionar opção padrão
              const defaultOption = document.createElement('option');
              defaultOption.value = '';
              defaultOption.textContent = 'Selecione uma coleção local...';
              localCollectionSelect.appendChild(defaultOption);
              
              // Adicionar opções para cada coleção
              message.collections.forEach(collection => {
                const option = document.createElement('option');
                option.value = collection.id;
                option.textContent = collection.name;
                localCollectionSelect.appendChild(option);
              });
              
              hideErrorUpdate();
            }
            
            // Atualizar a prévia se ambos os seletores tiverem valores
            if (librarySelectUpdate.value && localCollectionSelect.value) {
              updatePreview();
            }
            break;

          case 'libraries-data':
          const libraries = message.libraries || [];
          
            // Limpar e preencher o select com as bibliotecas
          librarySelect.innerHTML = '';
          librarySelectUpdate.innerHTML = '';
            librarySelectVar.innerHTML = '';
          
          // Adicionar opção padrão
          const defaultOption = document.createElement('option');
          defaultOption.value = '';
          defaultOption.textContent = libraries.length > 0 
            ? 'Selecione uma biblioteca...' 
            : 'Nenhuma biblioteca disponível';
          
            librarySelect.appendChild(defaultOption.cloneNode(true));
            librarySelectUpdate.appendChild(defaultOption.cloneNode(true));
            librarySelectVar.appendChild(defaultOption.cloneNode(true));
          
          // Adicionar opções para cada biblioteca
          libraries.forEach(library => {
            const option = document.createElement('option');
            option.value = library.id;
            option.textContent = library.name;
              
              librarySelect.appendChild(option.cloneNode(true));
              librarySelectUpdate.appendChild(option.cloneNode(true));
              librarySelectVar.appendChild(option.cloneNode(true));
            });
          
          // Mostrar bibliotecas no container principal
          componentsContainer.innerHTML = '';
          
          if (!libraries || libraries.length === 0) {
            componentsContainer.innerHTML = '<p class="no-components">Não foram encontradas bibliotecas neste arquivo</p>';
            return;
          }
          
          libraries.forEach((library) => {
              if (!library) return;
            
            const libraryElement = document.createElement('div');
            libraryElement.className = 'component-item';
            
            const labelElement = document.createElement('span');
            labelElement.className = 'library-label';
            labelElement.textContent = library.type || 'Biblioteca';
            libraryElement.appendChild(labelElement);
            
            const nameElement = document.createElement('div');
            nameElement.className = 'component-name';
            nameElement.textContent = library.name || 'Biblioteca sem nome';
            libraryElement.appendChild(nameElement);
            
            const idElement = document.createElement('div');
            idElement.className = 'component-id';
            idElement.textContent = `ID: ${library.id || 'Desconhecido'}`;
            libraryElement.appendChild(idElement);
            
            if (library.library) {
              const typeElement = document.createElement('div');
              typeElement.className = 'library-name';
              typeElement.textContent = library.library;
              libraryElement.appendChild(typeElement);
            }
            
            componentsContainer.appendChild(libraryElement);
          });
            break;

          case 'update-collections-result':
            // Atualizar o resultado da substituição de variáveis na coleção
            if (message.success) {
              showInfoUpdate(message.message);
            } else {
              showErrorUpdate(message.message);
            }
            updateButton.disabled = false;
            break;
        }
      };
      
      // Informa ao plugin que a UI está pronta
      parent.postMessage({ pluginMessage: { type: 'ui-ready' } }, '*');
      
      // Solicita especificamente as coleções locais
      setTimeout(() => {
        parent.postMessage({ pluginMessage: { type: 'carregarColecoesLocais' } }, '*');
      }, 500);

      // Função para lidar com clique no botão "carregar mais"
      function handleLoadMoreClick(event) {
        const button = event.target;
        const groupType = button.dataset.type;
        const groupId = button.dataset.group;
        const items = variablesByGroup[groupType];
        
        if (!items || items.length <= 5) return;
        
        // Encontra o grupo no DOM
        const groupElement = document.querySelector(`.variable-group[data-group="${groupId}"]`);
        if (!groupElement) return;
        
        const ul = groupElement.querySelector('ul');
        const existingItems = groupElement.querySelectorAll('li:not(.more-items)').length;
        
        // Obtém o HTML para os próximos 10 itens (ou o restante, se forem menos)
        let newItemsHtml = '';
        
        // Mapeamento de classes CSS para os tipos de estilo
        const styleClasses = {
          fills: 'fill',
          strokes: 'stroke',
          effects: 'effect',
          textStyles: 'text-style',
          grids: 'grid'
        };
        
        const isStyleGroup = ['fills', 'strokes', 'effects', 'textStyles', 'grids'].includes(groupType);
        
        items.slice(existingItems, existingItems + 10).forEach(item => {
          newItemsHtml += `<li>
            <span class="var-name" title="${item.name}">${item.name}</span>
            <span class="var-type ${isStyleGroup ? styleClasses[groupType] : groupType.slice(0, -1)}">
              ${isStyleGroup ? 'Estilo' : item.type}
            </span>
            ${item.collection ? `<span class="var-collection" title="${item.collection}">${item.collection}</span>` : ''}
          </li>`;
        });
        
        // Remove o botão atual
        const moreItemsLi = ul.querySelector('.more-items');
        if (moreItemsLi) {
          ul.removeChild(moreItemsLi);
        }
        
        // Adiciona os novos itens
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = newItemsHtml;
        while (tempDiv.firstChild) {
          ul.appendChild(tempDiv.firstChild);
        }
        
        // Se ainda houver mais itens para mostrar, adiciona um novo botão
        if (items.length > existingItems + 10) {
          const newMore = document.createElement('li');
          newMore.className = 'more-items';
          newMore.innerHTML = `
            <button class="load-more-button" data-group="${groupId}" data-type="${groupType}">
              Mostrar +${items.length - (existingItems + 10)} itens
            </button>
          `;
          ul.appendChild(newMore);
          
          // Adiciona o event listener ao novo botão
          newMore.querySelector('.load-more-button').addEventListener('click', handleLoadMoreClick);
        }
      }

      // Função para formatar e mostrar as correspondências com paginação
      function formatMatchesList(matches, filter = '') {
        if (!matches || matches.length === 0) {
          return `<p class="empty-message">Nenhuma correspondência encontrada.</p>`;
        }

        // Grupos para organizar as correspondências por variável local
        const matchGroups = [];

        // Aplicar filtro se existir
        const filteredMatches = filter ? 
          matches.filter(match => 
            match.localName.toLowerCase().includes(filter.toLowerCase()) || 
            (match.libraryName && match.libraryName.toLowerCase().includes(filter.toLowerCase()))
          ) : 
          matches;

        // Agrupar por variável local
        for (const match of filteredMatches) {
          matchGroups.push(`
            <div class="match-item">
              <div class="match-header">
                <div class="local-variable">${match.localName}</div>
              </div>
              ${match.modes && match.modes.length > 0 ? `
                <div class="modes-container">
                  <div class="modes-title">Modos</div>
                  <div class="modes-list">
                    ${match.modes.map(mode => `
                      <div class="mode-row">
                        <div class="mode-name">${mode.name}</div>
                        <div class="mode-value">→ ${mode.matchedVarName}</div>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
            </div>
          `);
        }

        // Retornar lista formatada
        return matchGroups.join('');
      }

      // Inicializar variáveis de paginação
      window.paginationState = {
        currentPage: 1,
        itemsPerPage: 30,
        showingAll: false
      };

      // Adicionar função para configurar os eventos da paginação
      function setupPaginationEvents() {
        // Botão Ver Anterior
        const prevButton = document.getElementById('prev-page');
        if (prevButton) {
          prevButton.addEventListener('click', () => {
            window.paginationState.currentPage--;
            updateMatchesDisplay();
          });
        }
        
        // Botão Ver Mais 30
        const showMoreButton = document.getElementById('show-more');
        if (showMoreButton) {
          showMoreButton.addEventListener('click', () => {
            window.paginationState.itemsPerPage += 30;
            updateMatchesDisplay();
          });
        }
        
        // Botão Ver Todas
        const showAllButton = document.getElementById('show-all');
        if (showAllButton) {
          showAllButton.addEventListener('click', () => {
            window.paginationState.showingAll = true;
            updateMatchesDisplay();
          });
        }
      }

      // Função para atualizar a exibição de correspondências
      function updateMatchesDisplay() {
        if (!window.matchesData || !Array.isArray(window.matchesData)) {
          previewContent.innerHTML = '<p class="warning">Não há correspondências disponíveis</p>';
          return;
        }
        
        // Obter filtro atual (se houver)
        const filterInput = document.querySelector('.matches-filter input');
        const currentFilter = filterInput ? filterInput.value : '';
        
        previewContent.innerHTML = formatMatchesList(window.matchesData, currentFilter);
        
        // Configurar eventos após atualizar o conteúdo
        setupPaginationEvents();
      }
    });
  </script>
</body>
</html> 
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biblioteca Sweep</title>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            color: #333;
        }
        
        .container {
            padding: 20px;
        }
        
        h2 {
            font-size: 16px;
            margin-bottom: 12px;
        }
        
        .component-item {
            padding: 12px;
            border-radius: 6px;
            background-color: #f5f5f5;
            margin-bottom: 8px;
        }
        
        .library-label {
            display: inline-block;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-right: 6px;
            background-color: #e0f2fe;
            color: #0284c7;
        }
        
        .component-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .component-id {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        
        .library-name {
            font-size: 12px;
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            background-color: #e6f7ff;
            color: #0070e0;
            margin-top: 4px;
        }
        
        .no-components {
            color: #888;
            font-style: italic;
        }
        
        .error-message {
            background-color: #fee2e2;
            color: #b91c1c;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 13px;
        }
        
        .info-message {
            background-color: #f0f9ff;
            color: #075985;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 13px;
        }
        
        .action-button {
            background-color: #0070e0;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            font-size: 13px;
            cursor: pointer;
            margin-top: 16px;
            display: block;
            width: 100%;
        }
        
        .action-button:hover {
            background-color: #0057b3;
        }

        .library-select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .collections-container {
            margin-top: 16px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .collection-item {
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 6px;
            background-color: #f9fafb;
        }

        .collection-name {
            font-weight: 500;
            font-size: 13px;
        }

        .collection-type {
            font-size: 11px;
            color: #6b7280;
            margin-top: 2px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            margin-top: 20px;
            margin-bottom: 10px;
            color: #374151;
        }

        .loading {
            text-align: center;
            color: #6b7280;
            font-style: italic;
            padding: 12px;
        }

        .hidden {
            display: none;
        }
        
        /* Estilos para as abas */
        .tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            background-color: #f3f4f6;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .tab {
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            text-align: center;
            flex: 1;
        }
        
        .tab.active {
            border-bottom-color: #0070e0;
            color: #0070e0;
            background-color: #fff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Estilos para a aba Update Variables */
        .variable-form {
            margin-top: 16px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 6px;
            color: #374151;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .form-select {
            background-color: white;
        }
        
        .form-help {
            font-size: 11px;
            color: #6b7280;
            margin-top: 4px;
        }
        
        .variable-preview {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px;
            margin-top: 16px;
        }
        
        .preview-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }
        
        .preview-content {
            font-size: 12px;
            color: #4b5563;
            font-family: 'Roboto Mono', monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="tabs">
            <div class="tab" data-tab="update-collections">Update Collections</div>
            <div class="tab" data-tab="update-variables">Update Variables</div>
            <div class="tab" data-tab="list-libs">List Libraries</div>
        </div>
        
        <!-- Aba Update Collections (antiga Update Variables) -->
        <div id="update-collections" class="tab-content">
            <h2>Atualizar Coleções de Variáveis</h2>
            
            <div class="form-row">
                <label for="library-select">Selecione a Biblioteca</label>
                <select id="library-select">
                    <option value="" disabled selected>-- Selecione uma biblioteca --</option>
                </select>
            </div>
            
            <div class="form-row">
                <label for="collection-select">Selecione a Coleção</label>
                <select id="collection-select" disabled>
                    <option value="" disabled selected>-- Selecione uma coleção --</option>
                </select>
            </div>
            
            <div class="form-row">
                <label for="old-prefix">Prefixo Atual (opcional)</label>
                <input type="text" id="old-prefix" placeholder="Ex: bg/">
            </div>
            
            <div class="form-row">
                <label for="new-prefix">Novo Prefixo (opcional)</label>
                <input type="text" id="new-prefix" placeholder="Ex: background/">
            </div>
            
            <button id="update-btn" disabled>Atualizar Variáveis</button>
            <div id="update-result"></div>
        </div>
        
        <!-- Nova Aba Update Variables -->
        <div id="update-variables" class="tab-content">
            <h2>Atualizar Variáveis em Nós</h2>
            
            <div class="form-row">
                <label for="var-library-select">Biblioteca de Referência</label>
                <select id="var-library-select">
                    <option value="" disabled selected>-- Selecione uma biblioteca --</option>
                </select>
            </div>
            
            <div class="form-row">
                <label for="var-collection-select">Coleção de Referência</label>
                <select id="var-collection-select" disabled>
                    <option value="" disabled selected>-- Selecione uma coleção --</option>
                </select>
            </div>
            
            <div class="radio-group">
                <label>Escopo da Substituição:</label>
                <div class="radio-option">
                    <input type="radio" id="scope-selection" name="scope" value="selection" checked>
                    <label for="scope-selection">Seleção Atual</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="scope-page" name="scope" value="page">
                    <label for="scope-page">Página Atual</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="scope-document" name="scope" value="document">
                    <label for="scope-document">Todo o Documento</label>
                </div>
            </div>
            
            <button id="update-nodes-btn" disabled>Atualizar Variáveis nos Nós</button>
            <div id="update-nodes-result"></div>
        </div>
        
        <!-- Aba List Libraries -->
        <div id="list-libs" class="tab-content">
            <h2>Bibliotecas Conectadas</h2>
            <div id="libraries-list">
                <p class="loading">Carregando bibliotecas...</p>
            </div>
        </div>
    </div>

    <script>
        // Inicializar as abas
        document.addEventListener('DOMContentLoaded', function() {
            // Configuração das abas
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            // Função para alternar abas
            function switchTab(tabId) {
                tabContents.forEach(content => {
                    content.classList.remove('active');
                });
                tabs.forEach(tab => {
                    tab.classList.remove('active');
                });
                
                document.getElementById(tabId).classList.add('active');
                document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
                
                // Envia mensagem para o plugin sobre a mudança de aba
                parent.postMessage({ pluginMessage: { type: 'tab-changed', tabId: tabId } }, '*');
            }
            
            // Adiciona eventos de clique às abas
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Ativar a primeira aba por padrão
            switchTab('update-collections');
            
            // Ouvir mensagens do plugin
            window.onmessage = (event) => {
                const message = event.data.pluginMessage;
                
                if (message.type === 'libraries-loaded') {
                    populateLibrariesList(message.libraries);
                    populateLibrariesDropdown(message.libraries, 'library-select');
                    populateLibrariesDropdown(message.libraries, 'var-library-select');
                }
                
                if (message.type === 'collections-loaded') {
                    populateCollectionsDropdown(message.collections, message.dropdownId);
                    enableUpdateButton(message.dropdownId);
                }
                
                if (message.type === 'variables-updated') {
                    showUpdateResult(message.result, message.targetId);
                }
            };
            
            // Inicializar os controles de UI
            initializeControls();
        });
        
        function initializeControls() {
            // Controles para a aba Update Collections
            document.getElementById('library-select').addEventListener('change', function() {
                const libraryId = this.value;
                document.getElementById('collection-select').innerHTML = '<option value="" disabled selected>-- Carregando coleções... --</option>';
                document.getElementById('collection-select').disabled = true;
                document.getElementById('update-btn').disabled = true;
                
                parent.postMessage({ 
                    pluginMessage: { 
                        type: 'load-collections', 
                        libraryId: libraryId,
                        dropdownId: 'collection-select'
                    } 
                }, '*');
            });
            
            document.getElementById('update-btn').addEventListener('click', function() {
                const libraryId = document.getElementById('library-select').value;
                const collectionId = document.getElementById('collection-select').value;
                const oldPrefix = document.getElementById('old-prefix').value;
                const newPrefix = document.getElementById('new-prefix').value;
                
                document.getElementById('update-result').innerHTML = 'Atualizando variáveis...';
                
                parent.postMessage({ 
                    pluginMessage: { 
                        type: 'update-variables', 
                        libraryId: libraryId,
                        collectionId: collectionId,
                        oldPrefix: oldPrefix,
                        newPrefix: newPrefix,
                        targetId: 'update-result'
                    } 
                }, '*');
            });
            
            // Controles para a nova aba Update Variables
            document.getElementById('var-library-select').addEventListener('change', function() {
                const libraryId = this.value;
                document.getElementById('var-collection-select').innerHTML = '<option value="" disabled selected>-- Carregando coleções... --</option>';
                document.getElementById('var-collection-select').disabled = true;
                document.getElementById('update-nodes-btn').disabled = true;
                
                parent.postMessage({ 
                    pluginMessage: { 
                        type: 'load-collections', 
                        libraryId: libraryId,
                        dropdownId: 'var-collection-select'
                    } 
                }, '*');
            });
            
            document.getElementById('update-nodes-btn').addEventListener('click', function() {
                const libraryId = document.getElementById('var-library-select').value;
                const collectionId = document.getElementById('var-collection-select').value;
                const scope = document.querySelector('input[name="scope"]:checked').value;
                
                document.getElementById('update-nodes-result').innerHTML = 'Atualizando variáveis nos nós...';
                
                parent.postMessage({ 
                    pluginMessage: { 
                        type: 'update-variables-in-nodes', 
                        libraryId: libraryId,
                        collectionId: collectionId,
                        scope: scope,
                        targetId: 'update-nodes-result'
                    } 
                }, '*');
            });
            
            // Carregar bibliotecas
            parent.postMessage({ pluginMessage: { type: 'load-libraries' } }, '*');
        }
        
        function populateLibrariesList(libraries) {
            const librariesList = document.getElementById('libraries-list');
            
            if (libraries.length === 0) {
                librariesList.innerHTML = '<p>Nenhuma biblioteca encontrada.</p>';
                return;
            }
            
            let html = '<ul>';
            libraries.forEach(lib => {
                html += `<li><strong>${lib.name}</strong> (${lib.id})`;
                
                if (lib.collections && lib.collections.length > 0) {
                    html += '<ul class="collection">';
                    lib.collections.forEach(collection => {
                        html += `<li>${collection.name} (${collection.id})</li>`;
                    });
                    html += '</ul>';
                } else {
                    html += ' - Nenhuma coleção disponível';
                }
                
                html += '</li>';
            });
            html += '</ul>';
            
            librariesList.innerHTML = html;
        }
        
        function populateLibrariesDropdown(libraries, dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            
            if (!dropdown) return;
            
            dropdown.innerHTML = '<option value="" disabled selected>-- Selecione uma biblioteca --</option>';
            
            libraries.forEach(lib => {
                const option = document.createElement('option');
                option.value = lib.id;
                option.textContent = lib.name;
                dropdown.appendChild(option);
            });
            
            dropdown.disabled = libraries.length === 0;
        }
        
        function populateCollectionsDropdown(collections, dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            
            if (!dropdown) return;
            
            dropdown.innerHTML = '<option value="" disabled selected>-- Selecione uma coleção --</option>';
            
            collections.forEach(collection => {
                const option = document.createElement('option');
                option.value = collection.id;
                option.textContent = collection.name;
                dropdown.appendChild(option);
            });
            
            dropdown.disabled = collections.length === 0;
        }
        
        function enableUpdateButton(dropdownId) {
            if (dropdownId === 'collection-select') {
                document.getElementById('update-btn').disabled = false;
            } else if (dropdownId === 'var-collection-select') {
                document.getElementById('update-nodes-btn').disabled = false;
            }
        }
        
        function showUpdateResult(result, targetId) {
            const resultElement = document.getElementById(targetId);
            resultElement.innerHTML = result;
        }
    </script>
</body>
</html> 